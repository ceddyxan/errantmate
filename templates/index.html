{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-6">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <div>
            <h1 class="text-xl sm:text-2xl font-bold text-green-800">Dashboard</h1>
            <p class="text-green-600 mt-1 text-sm sm:text-base">Delivery operations overview</p>
            <div class="mt-2 text-base sm:text-lg font-bold text-gray-700">
                Welcome {{ session.username }}
            </div>
        </div>
        {% if session.user_role == 'admin' %}
        <div class="flex flex-col sm:flex-row gap-2">
            <a href="{{ url_for('reports') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 sm:px-4 rounded inline-flex items-center text-sm sm:text-base mobile-btn">
                <i class="fas fa-chart-bar mr-2"></i> Reports
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Statistics - Modern Design with Offline Support -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8">
        <div class="modern-stat-card bg-gradient-to-r from-purple-500 to-indigo-600 p-4 md:p-6 rounded-2xl text-center shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300" data-stat-card="total">
            <div class="text-xs md:text-sm text-white/90 font-medium mb-2 uppercase tracking-wider">Total</div>
            <div class="text-2xl md:text-3xl lg:text-4xl font-bold text-white" data-stat="total_deliveries">{{ total_deliveries or 0 }}</div>
        </div>
        <div class="modern-stat-card bg-gradient-to-r from-green-500 to-emerald-600 p-4 md:p-6 rounded-2xl text-center shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300" data-stat-card="delivered">
            <div class="text-xs md:text-sm text-white/90 font-medium mb-2 uppercase tracking-wider">Delivered</div>
            <div class="text-2xl md:text-3xl lg:text-4xl font-bold text-white" data-stat="delivered_count">{{ delivered_count or 0 }}</div>
        </div>
        <div class="modern-stat-card bg-gradient-to-r from-blue-500 to-cyan-600 p-4 md:p-6 rounded-2xl text-center shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300" data-stat-card="in-transit">
            <div class="text-xs md:text-sm text-white/90 font-medium mb-2 uppercase tracking-wider">In Transit</div>
            <div class="text-2xl md:text-3xl lg:text-4xl font-bold text-white" data-stat="in_transit_count">{{ in_transit_count or 0 }}</div>
        </div>
        <div class="modern-stat-card bg-gradient-to-r from-pink-500 to-rose-600 p-4 md:p-6 rounded-2xl text-center shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300" data-stat-card="pending">
            <div class="text-xs md:text-sm text-white/90 font-medium mb-2 uppercase tracking-wider">Pending</div>
            <div class="text-2xl md:text-3xl lg:text-4xl font-bold text-white" data-stat="pending_count">{{ pending_count or 0 }}</div>
        </div>
    </div>

    <!-- Offline Data Storage -->
    <div id="offlineDataContainer" style="display: none;"
         data-deliveries="{{ deliveries[:10] | tojson | safe }}"
         data-total-deliveries="{{ total_deliveries or 0 }}"
         data-delivered-count="{{ delivered_count or 0 }}"
         data-pending-count="{{ pending_count or 0 }}"
         data-in-transit-count="{{ in_transit_count or 0 }}"
         data-total-revenue="{{ total_revenue or 0 }}"
         data-total-expenses="{{ total_expenses or 0 }}"
         data-net-profit="{{ net_profit or 0 }}">
    </div>

    <script>
        // Store current data for offline access using data attributes
        (function() {
            var container = document.getElementById('offlineDataContainer');
            
            // Parse deliveries data
            var deliveriesData = [];
            try {
                deliveriesData = JSON.parse(container.dataset.deliveries || '[]');
            } catch (e) {
                console.warn('Failed to parse deliveries data:', e);
            }
            
            // Create statistics data
            var statisticsData = {
                total_deliveries: Number(container.dataset.totalDeliveries || 0),
                delivered_count: Number(container.dataset.deliveredCount || 0),
                pending_count: Number(container.dataset.pendingCount || 0),
                in_transit_count: Number(container.dataset.inTransitCount || 0),
                total_revenue: Number(container.dataset.totalRevenue || 0),
                total_expenses: Number(container.dataset.totalExpenses || 0),
                net_profit: Number(container.dataset.netProfit || 0)
            };
            
            window.currentOfflineData = {
                deliveries: deliveriesData,
                statistics: statisticsData,
                timestamp: new Date().toISOString()
            };

            // Process deliveries data for offline use
            if (window.currentOfflineData.deliveries) {
                window.currentOfflineData.deliveries = window.currentOfflineData.deliveries.map(function(delivery) {
                    return {
                        id: delivery.id,
                        display_id: delivery.display_id,
                        status: delivery.status,
                        recipient: delivery.recipient_name,
                        amount: delivery.amount,
                        created_at: delivery.created_at ? new Date(delivery.created_at).toISOString() : ""
                    };
                });
            }

            // Enhanced offline mode integration
            if (window.OfflineMode) {
                // Override data extraction methods
                OfflineMode.getCurrentDeliveries = function() {
                    return window.currentOfflineData.deliveries || [];
                };
                
                OfflineMode.getCurrentStatistics = function() {
                    return window.currentOfflineData.statistics || {};
                };
                
                // Cache data immediately
                OfflineMode.cacheCurrentData();
            }
        })();
    </script>

    <style>
        .modern-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
        }
    </style>

    <script>
// Auto-refresh dashboard every 30 seconds
setInterval(() => {
    window.location.reload();
}, 30000);

// Add subtle animations
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.modern-stat-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease-out';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}