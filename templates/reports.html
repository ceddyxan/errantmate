{% extends 'base.html' %}

{% block content %}
<style>
@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
.animate-shimmer {
    animation: shimmer 2s infinite;
}
</style>
<div class="max-w-7xl mx-auto">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
        <div class="relative">
            <!-- Subtle Background Glow -->
            <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl blur-xl opacity-15"></div>
            
            <!-- Main Title Container -->
            <div class="relative bg-gradient-to-br from-slate-800/50 to-purple-900/50 rounded-2xl p-6 border border-purple-500/20 backdrop-blur-sm shadow-lg">
                <!-- Title with Subtle Effects -->
                <div class="relative">
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                        Reports & Analytics
                    </h1>
                    
                    <!-- Welcome Message and Subtitle -->
                    <p class="text-purple-200 mt-2 text-lg font-medium">
                        Welcome, {{ session.username }}!
                    </p>
                    <p class="text-purple-300 mt-1 text-base">
                        Delivery statistics and insights
                    </p>
                </div>
                
                <!-- Subtle Accent Line -->
                <div class="mt-3 h-0.5 bg-gradient-to-r from-blue-500/50 to-purple-500/50 rounded-full"></div>
            </div>
        </div>

        <!-- Enhanced Export Section -->
        <div class="bg-gradient-to-br from-slate-800/70 to-purple-900/70 rounded-2xl p-6 border border-purple-400/30 shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 backdrop-blur-sm">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div class="flex items-center">
                    <div class="p-4 bg-gradient-to-br from-purple-500 to-blue-500 rounded-xl mr-4 shadow-lg border border-purple-400/20">
                        <i class="fas fa-download text-white text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-black text-teal-300 drop-shadow-lg">Export Reports</h3>
                        <p class="text-cyan-300 text-sm font-semibold mt-1">Download delivery data in CSV format</p>
                    </div>
                </div>
                
                            </div>
            
            <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-purple-400/30">
                <a href="{{ url_for('export', period='daily') }}" 
                   class="group inline-flex items-center px-3 py-2 bg-teal-500 rounded-lg text-sm font-bold hover:bg-teal-600 transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105 border border-teal-400 flex-1 justify-center">
                    <i class="fas fa-calendar-day mr-2 text-cyan-200 group-hover:text-white group-hover:rotate-12 transition-all duration-300"></i>
                    <span class="font-black text-teal-100">Daily</span>
                </a>
                
                <a href="{{ url_for('export', period='weekly') }}" 
                   class="group inline-flex items-center px-3 py-2 bg-teal-500 rounded-lg text-sm font-bold hover:bg-teal-600 transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105 border border-teal-400 flex-1 justify-center">
                    <i class="fas fa-calendar-week mr-2 text-cyan-200 group-hover:text-white group-hover:rotate-12 transition-all duration-300"></i>
                    <span class="font-black text-teal-100">Weekly</span>
                </a>
                
                <a href="{{ url_for('export', period='monthly') }}" 
                   class="group inline-flex items-center px-3 py-2 bg-teal-500 rounded-lg text-sm font-bold hover:bg-teal-600 transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105 border border-teal-400 flex-1 justify-center">
                    <i class="fas fa-calendar-alt mr-2 text-cyan-200 group-hover:text-white group-hover:rotate-12 transition-all duration-300"></i>
                    <span class="font-black text-teal-100">Monthly</span>
                </a>
                
                <a href="{{ url_for('export', period='yearly') }}" 
                   class="group inline-flex items-center px-3 py-2 bg-teal-500 rounded-lg text-sm font-bold hover:bg-teal-600 transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105 border border-teal-400 flex-1 justify-center">
                    <i class="fas fa-calendar mr-2 text-cyan-200 group-hover:text-white group-hover:rotate-12 transition-all duration-300"></i>
                    <span class="font-black text-teal-100">Yearly</span>
                </a>
                
                <a href="{{ url_for('export', period='all') }}" 
                   class="group inline-flex items-center px-3 py-2 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-lg text-sm font-bold hover:from-purple-600 hover:to-indigo-600 transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105 border border-purple-400 flex-1 justify-center">
                    <i class="fas fa-infinity mr-2 text-purple-200 group-hover:text-white group-hover:rotate-12 transition-all duration-300"></i>
                    <span class="font-black text-purple-100">All Time</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Enhanced Date Range Filter -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-8 overflow-hidden">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
            <div class="flex items-center">
                <i class="fas fa-filter text-blue-600 mr-3"></i>
                <h3 class="text-lg font-semibold text-gray-800">Time Period Filter</h3>
            </div>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                <button onclick="filterData('today')" 
                        class="filter-btn group relative px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700 transition-all duration-200 transform hover:scale-105" 
                        data-period="today">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-sun text-lg mb-1 text-gray-400 group-hover:text-blue-500"></i>
                        <span>Today</span>
                    </div>
                </button>
                <button onclick="filterData('week')" 
                        class="filter-btn group relative px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700 transition-all duration-200 transform hover:scale-105" 
                        data-period="week">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-calendar-week text-lg mb-1 text-gray-400 group-hover:text-blue-500"></i>
                        <span>This Week</span>
                    </div>
                </button>
                <button onclick="filterData('month')" 
                        class="filter-btn group relative px-4 py-3 bg-blue-600 border border-blue-600 rounded-lg text-sm font-medium text-white shadow-md transform scale-105" 
                        data-period="month">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-calendar-alt text-lg mb-1"></i>
                        <span>This Month</span>
                    </div>
                </button>
                <button onclick="filterData('year')" 
                        class="filter-btn group relative px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700 transition-all duration-200 transform hover:scale-105" 
                        data-period="year">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-calendar text-lg mb-1 text-gray-400 group-hover:text-blue-500"></i>
                        <span>This Year</span>
                    </div>
                </button>
                <button onclick="filterData('all')" 
                        class="filter-btn group relative px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700 transition-all duration-200 transform hover:scale-105" 
                        data-period="all">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-infinity text-lg mb-1 text-gray-400 group-hover:text-blue-500"></i>
                        <span>All Time</span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
        <div class="group bg-gradient-to-br from-white to-indigo-50 rounded-2xl shadow-lg border border-indigo-100 overflow-hidden hover:shadow-2xl hover:border-indigo-300 hover:-translate-y-2 transition-all duration-300 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-indigo-200/30 to-transparent rounded-bl-full"></div>
            <div class="p-4 relative">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-indigo-700 text-sm font-black uppercase tracking-wider drop-shadow-sm">Total Deliveries</p>
                        <p class="text-5xl font-black text-indigo-800 mt-2 drop-shadow-md" id="total-deliveries">3</p>
                        <div class="flex items-center mt-3">
                            <span class="text-sm text-indigo-600 font-bold">All time</span>
                            <div class="ml-2 w-3 h-3 bg-indigo-500 rounded-full animate-pulse shadow-lg"></div>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl flex items-center justify-center shadow-xl border-2 border-indigo-300">
                        <i class="fas fa-box text-white text-2xl drop-shadow-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="group bg-gradient-to-br from-white to-emerald-50 rounded-2xl shadow-lg border border-emerald-100 overflow-hidden hover:shadow-2xl hover:border-emerald-300 hover:-translate-y-2 transition-all duration-300 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-emerald-200/30 to-transparent rounded-bl-full"></div>
            <div class="p-4 relative">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-emerald-700 text-sm font-black uppercase tracking-wider drop-shadow-sm">Delivered</p>
                        <p class="text-5xl font-black text-emerald-800 mt-2 drop-shadow-md" id="delivered">1</p>
                        <div class="flex items-center mt-3">
                            <span class="text-sm text-emerald-600 font-bold">Completed</span>
                            <div class="ml-2 w-3 h-3 bg-emerald-500 rounded-full animate-pulse shadow-lg"></div>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-black rounded-2xl flex items-center justify-center shadow-xl border-2 border-white">
                        <i class="fas fa-check-double text-white text-3xl font-bold"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="group bg-gradient-to-br from-white to-blue-50 rounded-2xl shadow-lg border border-blue-100 overflow-hidden hover:shadow-2xl hover:border-blue-300 hover:-translate-y-2 transition-all duration-300 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-blue-200/30 to-transparent rounded-bl-full"></div>
            <div class="p-4 relative">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-blue-700 text-sm font-black uppercase tracking-wider drop-shadow-sm">In Transit</p>
                        <p class="text-5xl font-black text-blue-800 mt-2 drop-shadow-md" id="in-transit">1</p>
                        <div class="flex items-center mt-3">
                            <span class="text-sm text-blue-600 font-bold">In progress</span>
                            <div class="ml-2 w-3 h-3 bg-blue-500 rounded-full animate-pulse shadow-lg"></div>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-cyan-700 rounded-2xl flex items-center justify-center shadow-xl border-2 border-blue-300">
                        <i class="fas fa-truck-loading text-white text-2xl drop-shadow-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="group bg-gradient-to-br from-white to-amber-50 rounded-2xl shadow-lg border border-amber-100 overflow-hidden hover:shadow-2xl hover:border-amber-300 hover:-translate-y-2 transition-all duration-300 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-amber-200/30 to-transparent rounded-bl-full"></div>
            <div class="p-4 relative">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-amber-700 text-sm font-black uppercase tracking-wider drop-shadow-sm">Pending</p>
                        <p class="text-5xl font-black text-amber-800 mt-2 drop-shadow-md" id="pending">1</p>
                        <div class="flex items-center mt-3">
                            <span class="text-sm text-amber-600 font-bold">Waiting</span>
                            <div class="ml-2 w-3 h-3 bg-amber-500 rounded-full animate-pulse shadow-lg"></div>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-black rounded-2xl flex items-center justify-center shadow-xl border-2 border-white">
                        <i class="fas fa-hourglass-half text-white text-3xl font-bold"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="group bg-gradient-to-br from-white to-green-50 rounded-2xl shadow-lg border border-green-100 overflow-hidden hover:shadow-2xl hover:border-green-300 hover:-translate-y-2 transition-all duration-300 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-green-200/30 to-transparent rounded-bl-full"></div>
            <div class="p-4 relative">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-green-600 text-sm font-black uppercase tracking-wider drop-shadow-sm">Revenue</p>
                        <p class="text-3xl font-black text-green-700 mt-2 drop-shadow-md" id="revenue">KSh 2830.00</p>
                        <div class="flex items-center mt-3">
                            <span class="text-sm text-green-600 font-bold">Total income</span>
                            <div class="ml-2 w-3 h-3 bg-green-500 rounded-full animate-pulse shadow-lg"></div>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-black rounded-2xl flex items-center justify-center shadow-xl border-2 border-white">
                        <i class="fas fa-money-bill-wave text-white text-3xl font-bold"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="group bg-gradient-to-br from-white to-red-50 rounded-2xl shadow-lg border border-red-100 overflow-hidden hover:shadow-2xl hover:border-red-300 hover:-translate-y-2 transition-all duration-300 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-red-200/30 to-transparent rounded-bl-full"></div>
            <div class="p-4 relative">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-red-700 text-sm font-black uppercase tracking-wider drop-shadow-sm">Delivery Costs</p>
                        <p class="text-3xl font-black text-red-800 mt-2 drop-shadow-md" id="expenses">KSh 860.00</p>
                        <div class="flex items-center mt-3">
                            <span class="text-sm text-red-600 font-bold">Total delivery costs</span>
                            <div class="ml-2 w-3 h-3 bg-red-500 rounded-full animate-pulse shadow-lg"></div>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-gradient-to-br from-red-600 to-pink-700 rounded-2xl flex items-center justify-center shadow-xl border-2 border-red-300">
                        <i class="fas fa-file-invoice-dollar text-white text-2xl drop-shadow-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        
            <!-- Delivery Status Chart -->
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-shadow duration-200">
            <div class="p-3">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-bold text-gray-900">Delivery Status</h3>
                    <select id="trendsPeriod" onchange="updateDeliveryTrends()" 
                            class="text-xs px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="7">7 days</option>
                        <option value="30" selected>30 days</option>
                        <option value="90">90 days</option>
                    </select>
                </div>
                <div class="relative h-24 mb-2">
                    <canvas id="deliveryTrendsChart"></canvas>
                </div>
                <div class="flex justify-center gap-2 text-xs">
                    <div class="flex items-center gap-1">
                        <div class="w-2 h-2 bg-amber-500 rounded-full"></div>
                        <span class="text-gray-700">Pending</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                        <span class="text-gray-700">In Transit</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                        <span class="text-gray-700">Delivered</span>
                    </div>
                </div>
            </div>
        </div>

        
            </div>

    <!-- Quick Actions, User Management, and Reassignment Cards -->
    <div class="{% if session.user_role == 'admin' %}grid grid-cols-1 lg:grid-cols-3{% else %}grid grid-cols-1 lg:grid-cols-2{% endif %} gap-6 mb-8">
        <!-- Quick Actions Card -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-lg transition-all duration-300">
            <div class="p-3">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-semibold text-gray-800">Quick Actions</h3>
                    <button onclick="toggleQuickActions()" 
                            id="toggleQuickActionsBtn"
                            class="text-gray-600 hover:text-gray-800 px-2 py-1 rounded hover:bg-gray-100 transition-colors flex items-center gap-1 text-xs"
                            title="Toggle quick actions">
                        <span>Actions</span>
                        <i class="fas fa-chevron-down text-xs transition-transform duration-200"></i>
                    </button>
                </div>
                
                <!-- Always Visible: Modern Unassigned/Pending Tabs -->
                <div class="mb-3">
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button onclick="showDeliveryType('unassigned')" id="unassignedTab" 
                                class="relative px-4 py-3 text-sm font-semibold rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg transform transition-all duration-200 hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-green-400">
                            <div class="flex items-center justify-center gap-2">
                                <i class="fas fa-exclamation-triangle text-xs"></i>
                                <span>Unassigned</span>
                            </div>
                            <div class="absolute inset-0 bg-white opacity-0 hover:opacity-20 rounded-lg transition-opacity duration-200"></div>
                        </button>
                        <button onclick="showDeliveryType('pending')" id="pendingTab" 
                                class="relative px-4 py-3 text-sm font-semibold rounded-lg bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg transform transition-all duration-200 hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <div class="flex items-center justify-center gap-2">
                                <i class="fas fa-clock text-xs"></i>
                                <span>Pending</span>
                            </div>
                            <div class="absolute inset-0 bg-white opacity-0 hover:opacity-20 rounded-lg transition-opacity duration-200"></div>
                        </button>
                    </div>
                    
                    <!-- Unassigned Deliveries Dropdown -->
                    <div id="unassignedSection">
                        <label class="text-sm font-medium text-gray-700 block mb-1">Unassigned Delivery (No Person)</label>
                        <select id="unassignedDeliveryInput" 
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select unassigned delivery...</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Deliveries with no delivery person assigned</p>
                    </div>
                    
                    <!-- Pending Deliveries Dropdown -->
                    <div id="pendingSection" class="hidden">
                        <label class="text-sm font-medium text-gray-700 block mb-1">Pending Delivery (Waiting Pickup)</label>
                        <select id="pendingDeliveryInput" 
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select pending delivery...</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">All deliveries waiting to be processed</p>
                    </div>
                </div>
                
                <!-- Collapsible Advanced Actions -->
                <div id="quickActionsContainer" class="hidden">
                    <div class="border-t border-gray-200 pt-3">
                        <!-- Delivery Person Fields - Only for Unassigned -->
                        <div id="updateFields">
                                                        
                            <!-- Delivery Person -->
                            <div class="mb-3">
                                <label class="text-sm font-medium text-gray-700 block mb-1">Delivery Person</label>
                                <select id="deliveryPersonSelect" 
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-t focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select existing delivery person...</option>
                                    <!-- Existing delivery persons will be loaded here -->
                                </select>
                                <input type="text" 
                                       id="deliveryPersonInput" 
                                       placeholder="Or enter new delivery person name..." 
                                       autocomplete="off"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 border-t-0 rounded-b focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Select from dropdown or type a new name</p>
                            </div>
                            
                            <!-- Buttons -->
                            <div class="flex gap-2 mb-3">
                                {% if session.user_role == 'staff' %}
                                <!-- Staff: Show Status Actions -->
                                <div class="flex-1 relative">
                                    <button onclick="toggleQuickStatusDropdown()" 
                                            class="w-full bg-blue-600 text-white px-3 py-2 text-sm font-medium rounded hover:bg-blue-700 flex items-center justify-center gap-2">
                                        <i class="fas fa-edit"></i>
                                        Update Status
                                        <i class="fas fa-chevron-down text-xs"></i>
                                    </button>
                                    <div id="quickStatusDropdown" 
                                         class="hidden absolute top-full left-0 right-0 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg z-10">
                                        <button onclick="quickUpdateStatus('Pending')" 
                                                class="block w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 border-b">
                                            <i class="fas fa-clock text-yellow-500 mr-2"></i>Pending
                                        </button>
                                        <button onclick="quickUpdateStatus('In Transit')" 
                                                class="block w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 border-b">
                                            <i class="fas fa-truck text-blue-500 mr-2"></i>In Transit
                                        </button>
                                        <button onclick="quickUpdateStatus('Delivered')" 
                                                class="block w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                            <i class="fas fa-check text-green-500 mr-2"></i>Delivered
                                        </button>
                                    </div>
                                </div>
                                {% else %}
                                <!-- Admin: Show Update Delivery Button -->
                                <button onclick="updateDelivery()" 
                                        class="flex-1 bg-blue-600 text-white px-3 py-2 text-sm font-medium rounded hover:bg-blue-700">
                                    Update Delivery
                                </button>
                                {% endif %}
                                <button onclick="clearDeliveryForm()" 
                                        class="flex-1 bg-gray-100 text-gray-700 px-3 py-2 text-sm font-medium rounded hover:bg-gray-200">
                                    Clear Form
                                </button>
                            </div>
                        </div>
                        
                        <!-- Simple Reassign Section - Only for Pending -->
                        <div id="reassignSection" class="border-t pt-3 hidden">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">Quick Reassign</h4>
                            <div id="reassignButtons" class="flex gap-2 flex-wrap">
                                <!-- Buttons will be dynamically generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Card (Admin Only) - NEW VERSION -->
        {% if session.user_role == 'admin' %}
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-lg transition-all duration-300">
            <div class="p-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <h3 class="text-sm font-semibold text-gray-800">User Management</h3>
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-medium">
                            <i class="fas fa-key mr-1"></i>Password View Enabled
                        </span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="showNewUserModal()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-medium transition-colors duration-200">
                            <i class="fas fa-plus mr-1"></i>Add User
                        </button>
                        <button onclick="refreshUsers()" 
                                class="text-gray-600 hover:text-gray-800 px-2 py-1 rounded hover:bg-gray-100 transition-colors flex items-center gap-1 text-xs"
                                title="Refresh users">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Users List -->
                <div class="mt-3 border-t border-gray-200 pt-3">
                    <div id="newUsersList" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="text-center text-gray-500 text-sm py-4">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading users...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Minimalistic Shelf Management Card (Admin Only) -->
        {% if session.user_role == 'admin' %}
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-all duration-200">
            <!-- Clean Header -->
            <div class="px-4 py-3 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                            <i class="fas fa-warehouse text-white text-sm"></i>
                        </div>
                        <div>
                            <h3 class="text-sm font-semibold text-gray-800">Shelf Management</h3>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="window.location.href='/rent_shelf'" 
                                class="text-gray-600 hover:text-gray-800 p-1.5 rounded hover:bg-gray-50 transition-colors"
                                title="Manage shelves">
                            <i class="fas fa-cog text-xs"></i>
                        </button>
                        <button onclick="refreshShelfStats()" 
                                id="refreshBtn"
                                class="text-gray-600 hover:text-gray-800 p-1.5 rounded hover:bg-gray-50 transition-colors"
                                title="Refresh statistics">
                            <i class="fas fa-sync-alt text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Clean Statistics Grid -->
            <div class="p-4">
                <div class="grid grid-cols-4 gap-3">
                    <!-- Available -->
                    <div class="text-center p-3 bg-green-50 rounded-lg border border-green-100">
                        <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-check text-white text-xs"></i>
                        </div>
                        <div class="text-xl font-bold text-gray-800 mb-1" id="availableShelvesCount">0</div>
                        <div class="text-xs text-gray-600">Available</div>
                    </div>
                    
                    <!-- Occupied -->
                    <div class="text-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                        <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-box text-white text-xs"></i>
                        </div>
                        <div class="text-xl font-bold text-gray-800 mb-1" id="occupiedShelvesCount">0</div>
                        <div class="text-xs text-gray-600">Occupied</div>
                    </div>
                    
                    <!-- Maintenance -->
                    <div class="text-center p-3 bg-yellow-50 rounded-lg border border-yellow-100">
                        <div class="w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-tools text-white text-xs"></i>
                        </div>
                        <div class="text-xl font-bold text-gray-800 mb-1" id="maintenanceShelvesCount">0</div>
                        <div class="text-xs text-gray-600">Maintenance</div>
                    </div>
                    
                    <!-- Revenue -->
                    <div class="text-center p-3 bg-purple-50 rounded-lg border border-purple-100">
                        <div class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-chart-line text-white text-xs"></i>
                        </div>
                        <div class="text-xl font-bold text-gray-800 mb-1" id="monthlyRevenueDisplay">KSh 0</div>
                        <div class="text-xs text-gray-600">Revenue</div>
                    </div>
                </div>
                
                <!-- Simple Actions -->
                <div class="mt-4 flex gap-2">
                    <button onclick="window.location.href='/rent_shelf'" 
                            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-xs font-medium transition-colors">
                        <i class="fas fa-plus mr-1"></i>Create
                    </button>
                    <button onclick="window.location.href='/rent_shelf'" 
                            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-xs font-medium transition-colors">
                        <i class="fas fa-wrench mr-1"></i>Maintain
                    </button>
                    <button onclick="exportShelfReport()" 
                            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-xs font-medium transition-colors">
                        <i class="fas fa-download mr-1"></i>Export
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

            </div>

    <!-- Enhanced Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden  hover:shadow-lg">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 px-6 py-4 border-b border-gray-200">
                <div class="flex items-center">
                    <i class="fas fa-chart-pie text-purple-600 mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-800">Status Distribution</h3>
                </div>
            </div>
            <div class="p-4">
                <div class="h-64">
                    <canvas id="statusDistributionChart"></canvas>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden  hover:shadow-lg">
            <div class="bg-gradient-to-r from-orange-50 to-red-50 px-6 py-4 border-b border-gray-200">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-orange-600 mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-800">Delivery Trends</h3>
                </div>
            </div>
            <div class="p-4">
                <div class="h-64">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue Analytics Section -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-8 hover:shadow-xl">
        <div class="bg-gradient-to-r from-emerald-50 to-teal-50 px-6 py-5 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-emerald-500 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-chart-line text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Revenue Analytics</h3>
                        <p class="text-sm text-gray-600 mt-1">Track your financial performance</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- Period Selector -->
                    <div class="flex bg-white rounded-lg shadow-md p-1">
                        <button onclick="setRevenuePeriod('daily')" id="revenueDailyBtn"
                                class="px-4 py-2 text-sm font-semibold rounded-md transition-all duration-300 bg-emerald-600 text-white shadow-md">
                            Daily
                        </button>
                        <button onclick="setRevenuePeriod('weekly')" id="revenueWeeklyBtn"
                                class="px-4 py-2 text-sm font-semibold rounded-md transition-all duration-300 text-gray-600 hover:text-gray-800 hover:bg-gray-50">
                            Weekly
                        </button>
                        <button onclick="setRevenuePeriod('monthly')" id="revenueMonthlyBtn"
                                class="px-4 py-2 text-sm font-semibold rounded-md transition-all duration-300 text-gray-600 hover:text-gray-800 hover:bg-gray-50">
                            Monthly
                        </button>
                    </div>
                    
                    <div class="text-right">
                        <span class="text-sm font-medium text-gray-700" id="revenueDateRange">Last 7 days</span>
                        <p class="text-xs text-gray-500">Selected period</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-6">
            <!-- Revenue Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm hover:shadow-md transition-all duration-300">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-emerald-500 rounded-2xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-money-bill-wave text-white text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Total Revenue</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalRevenueAnalytics">KSh 2,830</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-arrow-up text-emerald-600 text-xs"></i>
                        </div>
                        <span class="text-xs font-medium text-emerald-600">+12.5% from last period</span>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm hover:shadow-md transition-all duration-300">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-blue-500 rounded-2xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-chart-bar text-white text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Average Daily</p>
                            <p class="text-2xl font-bold text-gray-900" id="avgDailyRevenue">KSh 404</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-arrow-up text-blue-600 text-xs"></i>
                        </div>
                        <span class="text-xs font-medium text-blue-600">+8.3% from last period</span>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm hover:shadow-md transition-all duration-300">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-purple-500 rounded-2xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-trophy text-white text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Peak Day</p>
                            <p class="text-2xl font-bold text-gray-900" id="peakRevenueDay">KSh 1,630</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-star text-purple-600 text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs font-medium text-purple-600" id="peakDayName">Fri</p>
                            <p class="text-xs text-gray-400">Best performing day</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm hover:shadow-md transition-all duration-300">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-orange-500 rounded-2xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-rocket text-white text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Growth Rate</p>
                            <p class="text-2xl font-bold text-gray-900" id="revenueGrowthRate">+100.0%</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-fire text-orange-600 text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs font-medium text-orange-600">Month over month</p>
                            <p class="text-xs text-gray-400">Positive trend</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Revenue Chart -->
            <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-6 border border-gray-200 shadow-md">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h4 class="text-lg font-bold text-gray-800">Revenue Trend</h4>
                        <p class="text-sm text-gray-600 mt-1">Performance over selected period</p>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-emerald-500 rounded-full shadow-md"></div>
                            <span class="text-sm font-medium text-gray-700">Revenue</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-blue-500 rounded-full shadow-md"></div>
                            <span class="text-sm font-medium text-gray-700">Target</span>
                        </div>
                    </div>
                </div>
                <div class="h-80 bg-white rounded-lg p-4 shadow-inner">
                    <canvas id="revenueAnalyticsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Delivery Persons Section -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-8  hover:shadow-lg">
        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <button id="toggleDeliveryPersons" 
                        class="flex items-center text-indigo-600 hover:text-indigo-800 focus:outline-none transition-colors duration-200">
                    <i class="fas fa-chevron-down mr-2 transition-transform duration-200" id="deliveryPersonsToggleIcon"></i>
                    <span class="text-lg font-semibold">Delivery Persons</span>
                </button>
                
                <div class="flex items-center gap-3">
                    <!-- Summary Toggle -->
                    <button onclick="toggleDeliverySummary()" 
                            class="summary-toggle-btn px-3 py-1 text-xs bg-purple-100 border border-purple-200 rounded text-purple-600 hover:bg-purple-200 hover:border-purple-300 transition-all duration-200">
                        <i class="fas fa-chart-bar mr-1"></i>
                        <span class="summary-text">Show Summary</span>
                    </button>
                    
                    <!-- Time Period Filter -->
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">Period:</span>
                        <div class="flex gap-1">
                            <button onclick="filterDeliveryPersons('today')" 
                                    class="delivery-period-btn px-2 py-1 text-xs bg-gray-50 border border-gray-200 rounded text-gray-600 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700 transition-all duration-200" 
                                    data-period="today">
                                Today
                            </button>
                            <button onclick="filterDeliveryPersons('week')" 
                                    class="delivery-period-btn px-2 py-1 text-xs bg-gray-50 border border-gray-200 rounded text-gray-600 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700 transition-all duration-200" 
                                    data-period="week">
                                Week
                            </button>
                            <button onclick="filterDeliveryPersons('month')" 
                                    class="delivery-period-btn px-2 py-1 text-xs bg-blue-600 border border-blue-600 rounded text-white shadow-sm" 
                                    data-period="month">
                                Month
                            </button>
                            <button onclick="filterDeliveryPersons('all')" 
                                    class="delivery-period-btn px-2 py-1 text-xs bg-gray-50 border border-gray-200 rounded text-gray-600 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700 transition-all duration-200" 
                                    data-period="all">
                                All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Summary Section (Initially Hidden) -->
        <div id="deliverySummarySection" class="hidden bg-gradient-to-r from-purple-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="summaryContent">
                <!-- Summary will be loaded here -->
            </div>
        </div>
        
        <div id="deliveryPersonsContent" class="hidden">
            <div class="collapsible-container">
                <!-- Delivery persons will be loaded here -->
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-3"></i>
                    <p class="text-gray-500">Loading delivery persons...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Recent Deliveries Section -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden  hover:shadow-lg">
        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 px-6 py-4 border-b border-gray-200">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div class="flex items-center gap-3">
                    <button id="toggleDeliveries" 
                            class="flex items-center text-blue-600 hover:text-blue-800 focus:outline-none transition-colors duration-200">
                        <i class="fas fa-chevron-down mr-2 transition-transform duration-200" id="toggleIcon"></i>
                        <span class="text-lg font-semibold">Recent Deliveries</span>
                    </button>
                    <button id="exportCSVBtn" 
                            onclick="exportRecentDeliveriesToCSV()" 
                            class="flex items-center px-3 py-1.5 text-sm bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors duration-200"
                            title="Export to CSV">
                        <i class="fas fa-download mr-2"></i>
                        Export CSV
                    </button>
                </div>
                
                <!-- Recent Deliveries Filter -->
                <div id="recentDeliveriesFilter" class="hidden">
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <!-- Filter Section Headers -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- Date & Status Filters -->
                            <div class="space-y-3">
                                <!-- Date Filters -->
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-calendar-alt text-blue-600 text-sm"></i>
                                    <span class="text-sm font-semibold text-gray-700">Time Period</span>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="filterRecentDeliveries('today')" 
                                            class="recent-filter-btn px-3 py-1.5 text-sm bg-gray-50 border border-gray-200 rounded-lg text-gray-700 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700 transition-all duration-200" 
                                            data-period="today">
                                        Today
                                    </button>
                                    <button onclick="filterRecentDeliveries('week')" 
                                            class="recent-filter-btn px-3 py-1.5 text-sm bg-gray-50 border border-gray-200 rounded-lg text-gray-700 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700 transition-all duration-200" 
                                            data-period="week">
                                        This Week
                                    </button>
                                    <button onclick="filterRecentDeliveries('month')" 
                                            class="recent-filter-btn px-3 py-1.5 text-sm bg-blue-600 border border-blue-600 rounded-lg text-white shadow-sm" 
                                            data-period="month">
                                        This Month
                                    </button>
                                    <button onclick="filterRecentDeliveries('year')" 
                                            class="recent-filter-btn px-3 py-1.5 text-sm bg-gray-50 border border-gray-200 rounded-lg text-gray-700 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700 transition-all duration-200" 
                                            data-period="year">
                                        This Year
                                    </button>
                                </div>
                                
                                <!-- Status Filters -->
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-filter text-purple-600 text-sm"></i>
                                    <span class="text-sm font-semibold text-gray-700">Status</span>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="filterRecentDeliveriesByStatus('all')" 
                                            class="status-filter-btn px-3 py-1.5 text-sm bg-blue-600 border border-blue-600 rounded-lg text-white shadow-sm" 
                                            data-status="all">
                                        All
                                    </button>
                                    <button onclick="filterRecentDeliveriesByStatus('Pending')" 
                                            class="status-filter-btn px-3 py-1.5 text-sm bg-gray-50 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-100 hover:border-gray-300 hover:text-gray-800 transition-all duration-200" 
                                            data-status="Pending">
                                        Pending
                                    </button>
                                    <button onclick="filterRecentDeliveriesByStatus('In Transit')" 
                                            class="status-filter-btn px-3 py-1.5 text-sm bg-gray-50 border border-gray-200 rounded-lg text-gray-700 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700 transition-all duration-200" 
                                            data-status="In Transit">
                                        In Transit
                                    </button>
                                    <button onclick="filterRecentDeliveriesByStatus('Delivered')" 
                                            class="status-filter-btn px-3 py-1.5 text-sm bg-gray-50 border border-gray-200 rounded-lg text-gray-700 hover:bg-green-50 hover:border-green-300 hover:text-green-700 transition-all duration-200" 
                                            data-status="Delivered">
                                        Delivered
                                    </button>
                                </div>
                            </div>
                            <!-- Search Filter -->
                            <div class="space-y-3">
                                <!-- Search Filter -->
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-search text-green-600 text-sm"></i>
                                    <span class="text-sm font-semibold text-gray-700">Search</span>
                                </div>
                                <div class="relative">
                                    <input type="text" 
                                           id="searchInput"
                                           placeholder="Search deliveries..." 
                                           autocomplete="off"
                                           onkeyup="filterRecentDeliveriesBySearch(this.value)"
                                           class="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-search text-gray-400 text-sm"></i>
                                    </div>
                                </div>
                                <!-- Search Results Count -->
                                <div id="searchResultsCount" class="mt-2 text-xs text-gray-500 hidden">
                                    Found <span id="resultsCount" class="font-medium text-gray-700">0</span> results
                                </div>
                            </div>
                        </div>
                        
                        <!-- Active Filters Summary -->
                        <div id="activeFiltersSummary" class="mt-4 pt-3 border-t border-gray-200 hidden">
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500">Active filters:</span>
                                <button onclick="clearAllFilters()" class="text-xs text-red-600 hover:text-red-700 font-medium">
                                    Clear All
                                </button>
                            </div>
                            <div id="activeFiltersList" class="flex flex-wrap gap-1 mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="recentDeliveries" class="hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ref #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Display ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sender</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recipient</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Delivery Address</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Delivery Person</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pickup</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recentDeliveriesBody" class="bg-white divide-y divide-gray-200">
                        <!-- Deliveries will be loaded here -->
                        <tr>
                            <td colspan="11" class="text-center py-8">
                                <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-3"></i>
                                <p class="text-gray-500">Loading deliveries...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Load More Button -->
                <div id="loadMoreContainer" class="hidden mt-4 text-center">
                    <button id="loadMoreBtn" 
                            onclick="loadMoreDeliveries()" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                        <i class="fas fa-plus mr-2"></i>
                        Load More
                    </button>
                </div>
                
                <!-- Loading indicator for lazy loading -->
                <div id="lazyLoadingIndicator" class="hidden mt-4 text-center">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
                    <p class="text-gray-500 text-sm">Loading more deliveries...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delivery Details Modal -->
<div id="deliveryDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Delivery Details</h3>
            <button onclick="closeDeliveryDetailsModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="deliveryDetailsContent">
            <!-- Details will be loaded here -->
        </div>
    </div>
</div>

<!-- Chart.js is already loaded in base.html, no need for duplicate -->
<script>
// Global variables
let currentPeriod = 'month';
let currentFilters = {
    period: 'all',
    status: 'all',
    search: ''
};
let summaryData = null;
let statusChart = null;
let trendsChart = null;

// Filter data by period
function filterData(period) {
    currentPeriod = period;
    
    // Update button styles
    document.querySelectorAll('.filter-btn').forEach(btn => {
        if (btn.dataset.period === period) {
            btn.classList.remove('bg-gray-50', 'border-gray-200', 'text-gray-700');
            btn.classList.add('bg-blue-600', 'border-blue-600', 'text-white', 'shadow-md', 'transform', 'scale-105');
        } else {
            btn.classList.remove('bg-blue-600', 'border-blue-600', 'text-white', 'shadow-md', 'transform', 'scale-105');
            btn.classList.add('bg-gray-50', 'border-gray-200', 'text-gray-700');
        }
    });
    
    // Update dashboard
    updateDashboard(period);
}

// Update dashboard with filtered data
function updateDashboard(period) {
    // Update summary cards with the new period data
    if (summaryData) {
        updateSummaryCards(summaryData);
    }
    
    // Update charts with existing data
    if (summaryData && summaryData.deliveries) {
        updateChartsData(summaryData.deliveries, period);
    }
}

// Initialize charts
function createCharts() {
    // Create status chart
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        if (statusChart) {
            statusChart.destroy();
        }
        
        statusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Delivered (0%)', 'In Transit (0%)', 'Pending (0%)'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(251, 191, 36, 0.8)',
                        'rgba(156, 163, 175, 0.8)'
                    ],
                    borderColor: [
                        'rgba(34, 197, 94, 1)',
                        'rgba(251, 191, 36, 1)',
                        'rgba(156, 163, 175, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: [{
                    // Custom plugin to draw percentages on chart
                    id: 'percentageLabels',
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        const dataset = chart.data.datasets[0];
                        const meta = chart.getDatasetMeta(0);
                        
                        if (!dataset || !meta.data) return;
                        
                        const total = dataset.data.reduce((a, b) => a + b, 0);
                        if (total === 0) return;
                        
                        ctx.save();
                        ctx.font = 'bold 14px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        meta.data.forEach((segment, index) => {
                            const value = dataset.data[index];
                            if (value === 0) return;
                            
                            const percentage = ((value / total) * 100).toFixed(1);
                            const text = `${percentage}%`;
                            
                            // Calculate position on the segment
                            const angle = segment.startAngle + (segment.endAngle - segment.startAngle) / 2;
                            const x = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                            const y = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                            
                            // Position text in the middle of the segment
                            const radius = (segment.outerRadius + segment.innerRadius) / 2;
                            const textX = x + Math.cos(angle) * radius * 0.7;
                            const textY = y + Math.sin(angle) * radius * 0.7;
                            
                            // Draw white text with shadow for better visibility
                            ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                            ctx.shadowBlur = 4;
                            ctx.fillStyle = '#ffffff';
                            ctx.fillText(text, textX, textY);
                        });
                        
                        ctx.restore();
                    }
                },
                {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 12
                            },
                            // Generate custom labels with percentages
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    const dataset = data.datasets[0];
                                    const total = dataset.data.reduce((a, b) => a + b, 0);
                                    
                                    return data.labels.map((label, i) => {
                                        const value = dataset.data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: label,
                                            fillStyle: dataset.backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }]
            }
        });
    }
    
    // Create trends chart
    const trendsCtx = document.getElementById('trendsChart');
    if (trendsCtx) {
        if (trendsChart) {
            trendsChart.destroy();
        }
        
        trendsChart = new Chart(trendsCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Deliveries',
                    data: [],
                    borderColor: 'rgba(59, 130, 246, 1)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
    
    // Update charts with data if available
    if (summaryData && summaryData.deliveries) {
        updateChartsData(summaryData.deliveries, currentPeriod);
    }
}

// Filter deliveries by selected period
function filterDeliveriesByPeriod(deliveries, period) {
    if (!deliveries || deliveries.length === 0) return [];
    
    const now = new Date();
    let startDate = null;
    let endDate = null;
    
    switch (period) {
        case 'today':
            startDate = new Date(now);
            startDate.setHours(0, 0, 0, 0);
            endDate = new Date(now);
            endDate.setHours(23, 59, 59, 999);
            break;
        case 'week':
            startDate = new Date(now);
            const day = startDate.getDay();
            // Adjust to start from Monday (1) instead of Sunday (0) for better business week representation
            const diff = startDate.getDate() - day + (day === 0 ? -6 : 1);
            startDate.setDate(diff);
            startDate.setHours(0, 0, 0, 0);
            endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(23, 59, 59, 999);
            break;
        case 'month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            startDate.setHours(0, 0, 0, 0);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            endDate.setHours(23, 59, 59, 999);
            break;
        case 'year':
            startDate = new Date(now.getFullYear(), 0, 1);
            startDate.setHours(0, 0, 0, 0);
            endDate = new Date(now.getFullYear(), 11, 31);
            endDate.setHours(23, 59, 59, 999);
            break;
        default:
            return deliveries; // 'all' or unknown period
    }
    
    return deliveries.filter(delivery => {
        const deliveryDate = new Date(delivery.created_at);
        return deliveryDate >= startDate && deliveryDate <= endDate;
    });
}

function updateChartsData(deliveries, period = 'month') {
    if (!deliveries || deliveries.length === 0) return;
    
    // Filter deliveries by selected period
    const filteredDeliveries = filterDeliveriesByPeriod(deliveries, period);
    
    // Update status chart
    if (statusChart) {
        const delivered = filteredDeliveries.filter(d => d.status === 'Delivered').length;
        const inTransit = filteredDeliveries.filter(d => d.status === 'In Transit').length;
        const pending = filteredDeliveries.filter(d => d.status === 'Pending').length;
        const total = delivered + inTransit + pending;

        // Update data with percentages in labels
        statusChart.data.datasets[0].data = [delivered, inTransit, pending];
        
        // Update labels to show percentages
        const deliveredPct = total > 0 ? ((delivered / total) * 100).toFixed(1) : 0;
        const inTransitPct = total > 0 ? ((inTransit / total) * 100).toFixed(1) : 0;
        const pendingPct = total > 0 ? ((pending / total) * 100).toFixed(1) : 0;
        
        statusChart.data.labels = [
            `Delivered: ${delivered} (${deliveredPct}%)`,
            `In Transit: ${inTransit} (${inTransitPct}%)`,
            `Pending: ${pending} (${pendingPct}%)`
        ];
        
        statusChart.update();
    }

    // Update trends chart
    if (trendsChart) {
        const labels = [];
        const deliveryCounts = [];
        const now = new Date();

        switch (period) {
            case 'today':
                // Show hourly breakdown for today
                for (let i = 0; i < 24; i++) {
                    const hourStart = new Date(now);
                    hourStart.setHours(i, 0, 0, 0);
                    const hourEnd = new Date(now);
                    hourEnd.setHours(i, 59, 59, 999);

                    const hourDeliveries = deliveries.filter(d => {
                        const deliveryDate = new Date(d.created_at);
                        return deliveryDate >= hourStart && deliveryDate <= hourEnd;
                    });

                    labels.push(`${i}:00`);
                    deliveryCounts.push(hourDeliveries.length);
                }
                break;

            case 'week':
                // Show daily breakdown for current week
                const startOfWeek = new Date(now);
                const day = startOfWeek.getDay();
                // Adjust to start from Monday (1) instead of Sunday (0) for better business week representation
                const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
                startOfWeek.setDate(diff);
                startOfWeek.setHours(0, 0, 0, 0);

                for (let i = 0; i < 7; i++) {
                    const dayStart = new Date(startOfWeek);
                    dayStart.setDate(startOfWeek.getDate() + i);
                    const dayEnd = new Date(dayStart);
                    dayEnd.setHours(23, 59, 59, 999);

                    const dayDeliveries = deliveries.filter(d => {
                        const deliveryDate = new Date(d.created_at);
                        return deliveryDate >= dayStart && deliveryDate <= dayEnd;
                    });

                    labels.push(dayStart.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
                    deliveryCounts.push(dayDeliveries.length);
                }
                break;

            case 'month':
                // Show weekly breakdown for current month
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                const weeksInMonth = Math.ceil((endOfMonth.getDate() + startOfMonth.getDay()) / 7);

                for (let i = 0; i < weeksInMonth; i++) {
                    const weekStart = new Date(startOfMonth);
                    weekStart.setDate(startOfMonth.getDate() + (i * 7) - startOfMonth.getDay());
                    if (weekStart.getMonth() !== startOfMonth.getMonth()) {
                        weekStart.setDate(1);
                    }
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    let adjustedWeekEnd = weekEnd;
                    if (weekEnd.getMonth() !== startOfMonth.getMonth()) {
                        adjustedWeekEnd = new Date(endOfMonth);
                    }
                    adjustedWeekEnd.setHours(23, 59, 59, 999);

                    const weekDeliveries = deliveries.filter(d => {
                        const deliveryDate = new Date(d.created_at);
                        return deliveryDate >= weekStart && deliveryDate <= adjustedWeekEnd;
                    });

                    labels.push(`Week ${i + 1}`);
                    deliveryCounts.push(weekDeliveries.length);
                }
                break;

            case 'year':
                // Show monthly breakdown for current year
                for (let i = 0; i < 12; i++) {
                    const monthStart = new Date(now.getFullYear(), i, 1);
                    const monthEnd = new Date(now.getFullYear(), i + 1, 0);
                    monthEnd.setHours(23, 59, 59, 999);

                    const monthDeliveries = deliveries.filter(d => {
                        const deliveryDate = new Date(d.created_at);
                        return deliveryDate >= monthStart && deliveryDate <= monthEnd;
                    });

                    labels.push(monthStart.toLocaleDateString('en-US', { month: 'short' }));
                    deliveryCounts.push(monthDeliveries.length);
                }
                break;

            default:
                // Default to last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    date.setHours(0, 0, 0, 0);

                    const nextDate = new Date(date);
                    nextDate.setDate(nextDate.getDate() + 1);

                    const dayDeliveries = deliveries.filter(d => {
                        const deliveryDate = new Date(d.created_at);
                        return deliveryDate >= date && deliveryDate < nextDate;
                    });

                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                    deliveryCounts.push(dayDeliveries.length);
                }
        }

        trendsChart.data.labels = labels;
        trendsChart.data.datasets[0].data = deliveryCounts;
        trendsChart.update();
    }
}

// Simple Quick Actions functions
function updateDelivery() {
    const deliveryId = getSelectedDeliveryId();
    const deliveryPerson = document.getElementById('deliveryPersonInput').value.trim();
    
    if (!deliveryId) {
        showNotification('Please enter a delivery ID', 'error');
        return;
    }
    
    const data = {
        delivery_id: deliveryId,
        delivery_person: deliveryPerson
    };
    
    fetch('/update_delivery_expenses_and_person', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.status === 404) {
            // Try alternative endpoint
            return fetch('/update_delivery', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
        }
        return response;
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('Delivery updated successfully!', 'success');
            clearDeliveryForm();
            fetchSummaryData(); // Refresh charts
        } else {
            showNotification(result.message || 'Error updating delivery', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating delivery', 'error');
    });
}

function clearDeliveryForm() {
    document.getElementById('unassignedDeliveryInput').value = '';
    document.getElementById('pendingDeliveryInput').value = '';
    document.getElementById('deliveryPersonInput').value = '';
    document.getElementById('deliveryPersonSelect').value = '';
}
function fetchDeliveryPersons(period = 'month') {
    fetch(`/get_delivery_persons?period=${period}`)
        .then(response => {
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/login';
                    throw new Error('Authentication required');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(persons => {
            displayDeliveryPersons(persons, period);
        })
        .catch(error => {
            console.error('Error fetching delivery persons:', error);
            if (error.message !== 'Authentication required') {
                // Display empty state if fetch fails
                displayDeliveryPersons([], period);
            }
        });
}

// Display delivery persons in the UI
function displayDeliveryPersons(persons, period = 'month') {
    const content = document.getElementById('deliveryPersonsContent');
    if (!content) return;
    
    // Filter persons based on period (if needed)
    const filteredPersons = persons; // Add period filtering logic if needed
    
    if (filteredPersons.length === 0) {
        content.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-users text-gray-300 text-4xl mb-3"></i>
                <p class="text-gray-500">No delivery persons found</p>
            </div>
        `;
        return;
    }
    
    content.innerHTML = `
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${filteredPersons.map(person => `
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800">${person.name}</h4>
                                <p class="text-sm text-gray-600">Delivery Person</p>
                            </div>
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i class="fas fa-user text-blue-600"></i>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total assigned:</span>
                                <span class="font-medium">${person.delivery_count || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Pending:</span>
                                <span class="font-medium ${person.pending_count > 0 ? 'text-orange-600' : 'text-gray-600'}">${person.pending_count || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Delivered:</span>
                                <span class="font-medium ${person.delivered_count > 0 ? 'text-green-600' : 'text-gray-600'}">${person.delivered_count || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Revenue:</span>
                                <span class="font-medium">KSh ${(person.total_amount || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Delivery Costs:</span>
                                <span class="font-medium text-red-600">KSh ${(person.total_expenses || 0).toFixed(2)}</span>
                            </div>
                        </div>
                        ${person.daily_deliveries && Object.keys(person.daily_deliveries).length > 0 ? `
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-xs font-medium text-gray-700">Daily Deliveries:</div>
                                <button onclick="toggleDailyDeliveries(this)" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                                    <span class="expand-text">Show More</span>
                                    <span class="collapse-text hidden">Show Less</span>
                                </button>
                            </div>
                            <div class="daily-deliveries-content">
                                <div class="space-y-1 max-h-32 overflow-y-auto">
                                    ${Object.entries(person.daily_deliveries).sort((a, b) => b[0].localeCompare(a[0])).slice(0, 1).map(([date, deliveries]) => {
                                        const dateObj = new Date(date + 'T00:00:00');
                                        const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                        return `
                                        <div class="text-xs">
                                            <span class="text-gray-600">${formattedDate}:</span>
                                            <span class="font-medium">${deliveries.map(d => d.display_id).join(', ')}</span>
                                        </div>
                                    `;}).join('')}
                                </div>
                                <div class="daily-deliveries-full hidden space-y-1 max-h-32 overflow-y-auto">
                                    ${Object.entries(person.daily_deliveries).sort((a, b) => b[0].localeCompare(a[0])).map(([date, deliveries]) => {
                                        const dateObj = new Date(date + 'T00:00:00');
                                        const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                        return `
                                        <div class="text-xs">
                                            <span class="text-gray-600">${formattedDate}:</span>
                                            <span class="font-medium">${deliveries.map(d => d.display_id).join(', ')}</span>
                                        </div>
                                    `;}).join('')}
                                </div>
                                ${Object.keys(person.daily_deliveries).length > 1 ? `
                                <div class="text-xs text-gray-500 italic">
                                    +${Object.keys(person.daily_deliveries).length - 1} more days...
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

// Refresh delivery persons
function refreshDeliveryPersons() {
    fetchDeliveryPersons(currentPeriod);
}

// Filter delivery persons by period
function filterDeliveryPersons(period) {
    // Update button styles
    document.querySelectorAll('.delivery-period-btn').forEach(btn => {
        if (btn.dataset.period === period) {
            btn.classList.remove('bg-gray-50', 'border-gray-200', 'text-gray-600');
            btn.classList.add('bg-blue-600', 'border-blue-600', 'text-white', 'shadow-sm');
        } else {
            btn.classList.remove('bg-blue-600', 'border-blue-600', 'text-white', 'shadow-sm');
            btn.classList.add('bg-gray-50', 'border-gray-200', 'text-gray-600');
        }
    });
    
    // Refresh delivery persons with new period
    fetchDeliveryPersons(period);
}

// Initial fetch
fetchDeliveryPersons('month');

function fetchSummaryData() {
    fetch("{{ url_for('get_summary') }}")
        .then(response => {
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    // Authentication error - redirect to login
                    window.location.href = '/login';
                    throw new Error('Authentication required');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            summaryData = data;
            updateSummaryCards(data);
            createCharts();
            updateDashboard(currentPeriod);
        })
        .catch(error => {
            console.error('Error fetching summary data:', error);
            if (error.message !== 'Authentication required') {
                // Still create charts with empty data if fetch fails
                createCharts();
            }
        });
}

// Update summary cards with data
function updateSummaryCards(data) {
    if (!data) return;
    
    const periodData = data[currentPeriod] || data.month || {};
    
    // Update all summary cards
    const cards = [
        { id: 'total-deliveries', value: periodData.total_deliveries || 0 },
        { id: 'delivered', value: periodData.delivered || 0 },
        { id: 'in-transit', value: periodData.in_transit || 0 },
        { id: 'pending', value: periodData.pending || 0 },
        { id: 'revenue', value: `KSh ${(periodData.total_amount || 0).toFixed(2)}` },
        { id: 'expenses', value: `KSh ${(periodData.total_expenses || 0).toFixed(2)}` }
    ];
    
    cards.forEach(({ id, value }) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    });
    
    // Update UI elements
    updateChangeIndicators(periodData);
}

// Update change indicators
function updateChangeIndicators(summary) {
    const indicators = [
        { element: 'total-deliveries-change', field: 'total_deliveries_change' },
        { element: 'delivered-change', field: 'delivered_change' },
        { element: 'in-transit-change', field: 'in_transit_change' },
        { element: 'pending-change', field: 'pending_change' },
        { element: 'revenue-change', field: 'revenue_change' },
        { element: 'expenses-change', field: 'expenses_change' }
    ];
    
    indicators.forEach(({ element, field }) => {
        const el = document.getElementById(element);
        if (el && summary[field]) {
            el.textContent = summary[field];
        }
    });
}

fetchSummaryData();

// Global variables for pagination state
let currentPage = 1;
let deliveriesPerPage = 20;
let isLoadingMore = false;
let hasMoreData = true;

window.fetchRecentDeliveries = function(append = false) {
    console.log('fetchRecentDeliveries called - append:', append, 'currentPage:', currentPage);
    if (isLoadingMore) return;
    
    isLoadingMore = true;
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (loadingIndicator) loadingIndicator.classList.remove('hidden');
    
    const page = append ? currentPage : 1;
    const url = `/get_recent_deliveries?page=${page}&per_page=${deliveriesPerPage}`;
    console.log('Fetching URL:', url);
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/login';
                    throw new Error('Authentication required');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.deliveries && data.pagination) {
                displayRecentDeliveries(data.deliveries, append);
                updatePagination(data.pagination);
                // Update load more button visibility
                hasMoreData = data.pagination.has_next;
                currentPage = data.pagination.page;
                updateLoadMoreButton();
            } else {
                console.error('Unexpected data format:', data);
                displayRecentDeliveriesError();
            }
        })
        .catch(error => {
            console.error('Error fetching recent deliveries:', error);
            displayRecentDeliveriesError();
        })
        .finally(() => {
            isLoadingMore = false;
            if (loadingIndicator) loadingIndicator.classList.add('hidden');
        });
};

window.updateActiveFilters = function() {
    const activeFiltersSummary = document.getElementById('activeFiltersSummary');
    const activeFiltersList = document.getElementById('activeFiltersList');
    
    const activeFilters = [];
    
    const searchValue = document.getElementById('searchInput').value.trim();
    if (searchValue) {
        activeFilters.push(`Search: "${searchValue}"`);
    }
    
    const activePeriodBtn = document.querySelector('.recent-filter-btn:not(.bg-gray-50)');
    if (activePeriodBtn && !activePeriodBtn.dataset.period.includes('month')) {
        activeFilters.push(`Period: ${activePeriodBtn.textContent.trim()}`);
    }
    
    const activeStatusBtn = document.querySelector('.status-filter-btn:not(.bg-gray-50)');
    if (activeStatusBtn && !activeStatusBtn.dataset.status.includes('all')) {
        activeFilters.push(`Status: ${activeStatusBtn.textContent.trim()}`);
    }
    
    if (activeFilters.length > 0) {
        activeFiltersSummary.classList.remove('hidden');
        activeFiltersList.innerHTML = activeFilters.map(filter => 
            `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200">${filter}</span>`
        ).join('');
    } else {
        activeFiltersSummary.classList.add('hidden');
    }
    
    renumberVisibleRows();
};

function renumberVisibleRows() {
    const tbody = document.getElementById('recentDeliveriesBody');
    const visibleRows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.style.display !== 'none');
    
    visibleRows.forEach((row, index) => {
        const idCell = row.querySelector('td:nth-child(1)');
        if (idCell) {
            idCell.textContent = `#${index + 1}`;
        }
    });
}

// Helper function to get status update button based on user role and delivery assignment
window.getStatusUpdateButton = function(delivery) {
    const isStaff = '{{ session.user_role }}' === 'staff';
    const isAdmin = '{{ session.user_role }}' === 'admin';
    const currentUsername = '{{ session.username }}';
    
    // Debug logging
    console.log('getStatusUpdateButton called:', {
        isStaff: isStaff,
        isAdmin: isAdmin,
        currentUsername: currentUsername,
        deliveryPerson: delivery.delivery_person,
        deliveryId: delivery.id
    });
    
    if (isAdmin || (isStaff && delivery.delivery_person === currentUsername)) {
        // Admin: Show Status Dropdown for all deliveries
        // Staff: Show Status Dropdown only for their own deliveries
        console.log('Showing status dropdown for delivery:', delivery.id);
        return `
            <div class="relative inline-block">
                <button onclick="toggleStatusDropdown('${delivery.id}')" 
                        class="text-green-600 hover:text-green-800 transition-colors duration-200"
                        title="Update Status">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <div id="status-dropdown-${delivery.id}" 
                     class="hidden absolute right-0 mt-1 w-32 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
                    <button onclick="updateDeliveryStatus('${delivery.id}', 'Pending')" 
                            class="block w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-clock text-yellow-500 mr-2"></i>Pending
                    </button>
                    <button onclick="updateDeliveryStatus('${delivery.id}', 'In Transit')" 
                            class="block w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-truck text-blue-500 mr-2"></i>In Transit
                    </button>
                    <button onclick="updateDeliveryStatus('${delivery.id}', 'Delivered')" 
                            class="block w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-check text-green-500 mr-2"></i>Delivered
                    </button>
                </div>
            </div>
        `;
    } else if (isStaff && delivery.delivery_person !== currentUsername) {
        // Staff: Show locked icon for other users' deliveries
        console.log('Showing locked icon for delivery:', delivery.id);
        return `
            <button disabled 
                    class="text-gray-400 cursor-not-allowed transition-colors duration-200"
                    title="Status updates only allowed for your assigned deliveries">
                <i class="fas fa-lock"></i>
            </button>
        `;
    } else {
        // Other roles: No status update button
        console.log('No status button for delivery:', delivery.id, '- Reason:', {
            isStaff: isStaff,
            isAdmin: isAdmin,
            deliveryPerson: delivery.delivery_person,
            currentUsername: currentUsername
        });
        return '';
    }
};

// Helper function to get edit button based on user role
window.getEditButton = function(delivery) {
    const isStaff = '{{ session.user_role }}' === 'staff';
    const isAdmin = '{{ session.user_role }}' === 'admin';
    
    if (isStaff) {
        // Staff: Always show Edit button for delivery details
        return `
            <button onclick="editDelivery('${delivery.id}')" 
                    class="text-blue-600 hover:text-blue-800 transition-colors duration-200"
                    title="Update Delivery">
                <i class="fas fa-edit"></i>
            </button>
        `;
    } else if (!isAdmin) {
        // Other Roles: Show Edit Button
        return `
            <button onclick="editDelivery('${delivery.id}')" 
                    class="text-blue-600 hover:text-blue-800 transition-colors duration-200"
                    title="Edit">
                <i class="fas fa-edit"></i>
            </button>
        `;
    } else {
        // Admin: No separate edit button (they have full access)
        return '';
    }
};

function displayRecentDeliveries(deliveries) {
    const tbody = document.getElementById('recentDeliveriesBody');
    
    if (deliveries.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center py-8">
                    <i class="fas fa-inbox text-gray-300 text-4xl mb-3"></i>
                    <p class="text-gray-500">No recent deliveries found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = deliveries.map((delivery, index) => `
            <tr class="hover:bg-gray-50 transition-colors duration-150" data-date="${delivery.created_at}" data-delivery-person="${delivery.delivery_person || ''}" data-original-id="${delivery.display_id}">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${index + 1}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${delivery.display_id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div class="flex flex-col">
                        <span class="font-medium text-gray-900">${delivery.sender_name}</span>
                        <span class="text-xs text-gray-400">${delivery.sender_phone}</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div class="flex flex-col">
                        <span class="font-medium text-gray-900">${delivery.recipient_name}</span>
                        <span class="text-xs text-gray-400">${delivery.recipient_phone}</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div class="max-w-xs" title="${delivery.recipient_address || 'No address'}">
                        <span class="truncate block">${delivery.recipient_address || 'No address'}</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${delivery.delivery_person || 'Not assigned'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full
                        ${delivery.payment_by === 'Errant' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                        ${delivery.payment_by || 'Unknown'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <span class="font-semibold text-green-600">KSh ${delivery.amount ? delivery.amount.toFixed(2) : '0.00'}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full transition-all duration-200
                        ${delivery.status === 'Delivered' ? 'bg-green-100 text-green-800 hover:bg-green-200' :
                          delivery.status === 'In Transit' ? 'bg-blue-100 text-blue-800 hover:bg-blue-200' :
                          'bg-gray-100 text-gray-800 hover:bg-gray-200'}">
                        ${delivery.status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="flex flex-col">
                            <span class="font-medium text-gray-900">${formatLocalDateTime(delivery.created_at)}</span>
                            <span class="text-xs text-gray-400">${getTimeAgo(delivery.created_at)}</span>
                        </div>
                    </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div class="flex space-x-2">
                        <button onclick="viewDeliveryDetails('${delivery.id}')" 
                                class="text-blue-600 hover:text-blue-800 transition-colors duration-200"
                                title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${getStatusUpdateButton(delivery)}
                        ${getEditButton(delivery)}
                        <button onclick="deleteDelivery('${delivery.id}')" 
                                class="text-red-600 hover:text-red-800 transition-colors duration-200"
                                title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
}

window.displayRecentDeliveriesError = function() {
    const tbody = document.getElementById('recentDeliveriesBody');
    tbody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-3"></i>
                    <p class="text-gray-500">Error loading recent deliveries</p>
                    <button onclick="fetchRecentDeliveriesWithFilter()" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                        <i class="fas fa-retry mr-1"></i>
                        Try Again
                    </button>
                </td>
            </tr>
        `;
};

// Update pagination information
window.updatePagination = function(pagination) {
    const paginationInfo = document.getElementById('paginationInfo');
    if (paginationInfo) {
        paginationInfo.innerHTML = `
            Showing ${pagination.page * pagination.per_page - pagination.per_page + 1} to 
            ${Math.min(pagination.page * pagination.per_page, pagination.total)} of ${pagination.total} deliveries
        `;
    }
    
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    if (loadMoreBtn) {
        if (pagination.has_next) {
            loadMoreBtn.classList.remove('hidden');
            loadMoreBtn.disabled = false;
            loadMoreBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Load More';
        } else {
            loadMoreBtn.classList.add('hidden');
        }
    }
    
    hasMoreData = pagination.has_next;
    currentPage = pagination.page;
};

// Update load more button visibility and state
window.updateLoadMoreButton = function() {
    const loadMoreContainer = document.getElementById('loadMoreContainer');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    
    if (!loadMoreContainer || !loadMoreBtn) return;
    
    if (hasMoreData) {
        loadMoreContainer.classList.remove('hidden');
        loadMoreBtn.disabled = false;
        loadMoreBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Load More';
    } else {
        loadMoreContainer.classList.add('hidden');
    }
};

// Fetch recent deliveries with period filter
window.fetchRecentDeliveriesWithFilter = function() {
    if (isLoadingMore) return;
    
    isLoadingMore = true;
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (loadingIndicator) loadingIndicator.classList.remove('hidden');
    
    const url = `/get_recent_deliveries?page=1&per_page=${deliveriesPerPage}`;
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/login';
                    throw new Error('Authentication required');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.deliveries && data.pagination) {
                // Filter deliveries based on current period
                const filteredDeliveries = filterDeliveriesByPeriod(data.deliveries, currentPeriod);
                displayRecentDeliveries(filteredDeliveries, false);
                updatePagination(data.pagination);
                // Update load more button visibility
                hasMoreData = data.pagination.has_next;
                currentPage = data.pagination.page;
                updateLoadMoreButton();
            } else {
                displayRecentDeliveriesError();
            }
        })
        .catch(error => {
            console.error('Error fetching recent deliveries:', error);
            if (error.message !== 'Authentication required') {
                displayRecentDeliveriesError();
            }
        })
        .finally(() => {
            isLoadingMore = false;
            if (loadingIndicator) loadingIndicator.classList.add('hidden');
        });
};

// Helper function to filter deliveries by period
window.filterDeliveriesByPeriod = function(deliveries, period) {
    if (!deliveries || period === 'all') return deliveries;
    
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    let startDate;
    switch (period) {
        case 'today':
            startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            break;
        case 'week':
            startDate = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            break;
        case 'year':
            startDate = new Date(today.getFullYear(), 0, 1);
            break;
        default:
            return deliveries;
    }
    
    return deliveries.filter(delivery => {
        const deliveryDate = new Date(delivery.created_at);
        return deliveryDate >= startDate;
    });
};

// Load more deliveries
window.loadMoreDeliveries = function() {
    console.log('Load More clicked - isLoadingMore:', isLoadingMore, 'hasMoreData:', hasMoreData, 'currentPage:', currentPage);
    if (isLoadingMore || !hasMoreData) return;
    
    currentPage++;
    console.log('Loading page:', currentPage);
    fetchRecentDeliveries(true); // append = true
};

// Helper function to get status color
window.getStatusColor = function(status) {
    switch (status.toLowerCase()) {
        case 'delivered':
            return 'bg-green-100 text-green-800';
        case 'in transit':
            return 'bg-blue-100 text-blue-800';
        case 'pending':
            return 'bg-yellow-100 text-yellow-800';
        default:
            return 'bg-gray-100 text-gray-800';
    }
};

window.toggleStatusDropdown = function(deliveryId) {
    const dropdown = document.getElementById(`status-dropdown-${deliveryId}`);
    
    // Close all other dropdowns
    document.querySelectorAll('[id^="status-dropdown-"]').forEach(d => {
        if (d.id !== `status-dropdown-${deliveryId}`) {
            d.classList.add('hidden');
        }
    });
    
    // Toggle current dropdown
    dropdown.classList.toggle('hidden');
};

window.updateDeliveryStatus = function(deliveryId, newStatus) {
    document.getElementById(`status-dropdown-${deliveryId}`).classList.add('hidden');
    
    // Check user role and set up API call
    const isStaff = '{{ session.user_role }}' === 'staff';
    const isAdmin = '{{ session.user_role }}' === 'admin';
    const currentUsername = '{{ session.username }}';
    
    // Use the API endpoint for both staff and admin users
    const url = '/api/update_delivery_status';
    
    let payload = {
        delivery_id: deliveryId,
        status: newStatus
    };
    
    // Add delivery person assignment for staff users only
    if (isStaff) {
        payload.delivery_person = currentUsername;
    }
    
    // Update status via API
    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            let message = `Status updated to ${newStatus}`;
            if (isStaff && currentUsername) {
                message += ` and assigned to ${currentUsername}`;
            }
            showNotification(message, 'success');
            
            // Instant update: Refresh Status Distribution chart immediately
            updateStatusDistributionForPeriod('month');
            
            // Also refresh other views
            refreshCurrentView();
        } else {
            showNotification(result.error || 'Error updating status', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating status:', error);
        showNotification('Error updating status', 'error');
    });
};

window.toggleQuickStatusDropdown = function() {
    const dropdown = document.getElementById('quickStatusDropdown');
    dropdown.classList.toggle('hidden');
    
    // Close dropdown when clicking outside
    if (!dropdown.classList.contains('hidden')) {
        setTimeout(() => {
            document.addEventListener('click', closeQuickStatusDropdown);
        }, 100);
    }
};

window.closeQuickStatusDropdown = function(e) {
    const dropdown = document.getElementById('quickStatusDropdown');
    const button = dropdown.previousElementSibling;
    
    if (!dropdown.contains(e.target) && !button.contains(e.target)) {
        dropdown.classList.add('hidden');
        document.removeEventListener('click', closeQuickStatusDropdown);
    }
};

window.quickUpdateStatus = function(newStatus) {
    const dropdown = document.getElementById('quickStatusDropdown');
    dropdown.classList.add('hidden');
    document.removeEventListener('click', closeQuickStatusDropdown);
    
    // Get selected delivery (either unassigned or pending)
    const unassignedDelivery = document.getElementById('unassignedDeliveryInput').value;
    const pendingDelivery = document.getElementById('pendingDeliveryInput').value;
    
    let deliveryId = null;
    if (unassignedDelivery && unassignedDelivery !== '') {
        deliveryId = unassignedDelivery;
    } else if (pendingDelivery && pendingDelivery !== '') {
        deliveryId = pendingDelivery;
    }
    
    if (!deliveryId) {
        showNotification('Please select a delivery first', 'error');
        return;
    }
    
    // Use the existing updateDeliveryStatus function
    updateDeliveryStatus(deliveryId, newStatus);
};

window.refreshCurrentView = function() {
    // Refresh the current view based on what's visible
    const recentDeliveries = document.getElementById('recentDeliveries');
    if (recentDeliveries && !recentDeliveries.classList.contains('hidden')) {
        fetchRecentDeliveriesWithFilter();
    }
    
    // Also refresh other sections if needed
    loadUnassignedDeliveries();
    loadPendingDeliveries();
    
    // Note: Status Distribution chart is updated instantly in updateDeliveryStatus
};

window.deleteDelivery = function(deliveryId) {
    if (confirm(`Are you sure you want to delete delivery #${deliveryId}? This action cannot be undone.`)) {
        fetch(`/delete_delivery/${deliveryId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                showNotification('Delivery deleted successfully', 'success');
                
                // Instant update: Refresh Status Distribution chart immediately
                updateStatusDistributionForPeriod('month');
                
                // Refresh other views
                refreshCurrentView();
            } else {
                showNotification('Error deleting delivery. Please try again.', 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting delivery:', error);
            showNotification('Error deleting delivery. Please try again.', 'error');
        });
    }
};

// Delivery Details Modal Functions
window.viewDeliveryDetails = function(deliveryId) {
    const modal = document.getElementById('deliveryDetailsModal');
    const content = document.getElementById('deliveryDetailsContent');
    
    content.innerHTML = `
        <div class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-blue-600 text-2xl mb-3"></i>
            <p class="text-gray-500">Loading delivery details...</p>
        </div>
    `;
    
    // Show modal
    modal.classList.remove('hidden');
    
    // Fetch delivery details
    fetch(`/get_delivery_details/${deliveryId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(delivery => {
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Display ID</label>
                                <p class="mt-1 text-sm text-gray-900">${delivery.display_id}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Status</label>
                                <span class="mt-1 inline-flex px-2 py-1 text-xs leading-5 font-semibold rounded-full
                                    ${delivery.status === 'Delivered' ? 'bg-green-100 text-green-800' :
                                      delivery.status === 'In Transit' ? 'bg-blue-100 text-blue-800' :
                                      'bg-gray-100 text-gray-800'}">
                                    ${delivery.status}
                                </span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Sender</label>
                                <p class="mt-1 text-sm text-gray-900">${delivery.sender_name}</p>
                                <p class="text-xs text-gray-500">${delivery.sender_phone}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Recipient</label>
                                <p class="mt-1 text-sm text-gray-900">${delivery.recipient_name}</p>
                                <p class="text-xs text-gray-500">${delivery.recipient_phone}</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700">Delivery Address</label>
                            <p class="mt-1 text-sm text-gray-900">${delivery.recipient_address}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Goods Type</label>
                                <p class="mt-1 text-sm text-gray-900">${delivery.goods_type}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Quantity</label>
                                <p class="mt-1 text-sm text-gray-900">${delivery.quantity}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Amount</label>
                                <p class="mt-1 text-sm text-gray-900">KSh ${delivery.amount.toFixed(2)}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Delivery Costs</label>
                                <p class="mt-1 text-sm text-gray-900">KSh ${delivery.expenses.toFixed(2)}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Payment By</label>
                                <p class="mt-1 text-sm text-gray-900">${delivery.payment_by}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Delivery Person</label>
                                <p class="mt-1 text-sm text-gray-900">${delivery.delivery_person || 'Not assigned'}</p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700">Created At</label>
                            <p class="mt-1 text-sm text-gray-900">${getTimeAgo(delivery.created_at)}</p>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
            content.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-3"></i>
                    <p class="text-gray-500">Error loading delivery details</p>
                    <button onclick="closeDeliveryDetailsModal()" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                        Close
                    </button>
                </div>
            `;
        });
};

window.closeDeliveryDetailsModal = function() {
    document.getElementById('deliveryDetailsModal').classList.add('hidden');
};

// Toggle sections
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Load More button visibility
    // Check if we have initial deliveries data and if there might be more
    const initialDeliveries = parseInt('{{ recent_deliveries|length }}') || 0;
    if (initialDeliveries >= 10) {
        hasMoreData = true;
        updateLoadMoreButton();
    }
    
    // Initial data fetch for charts
    fetchSummaryData();
    
    // Initialize Status Distribution chart
    updateStatusDistributionForPeriod('month');
    
    // Load both types of deliveries
    loadUnassignedDeliveries();
    loadPendingDeliveries();
    
    // Load available delivery persons for reassign buttons
    loadAvailableDeliveryPersons();
    
    // Load existing delivery persons for dropdown
    loadDeliveryPersonsDropdown();
    
    // Check for delivery creation events from sessionStorage
    checkForDeliveryCreation();
    
    // Listen for storage changes (cross-tab communication)
    window.addEventListener('storage', function(e) {
        if (e.key === 'deliveryCreated' && e.newValue === 'true') {
            console.log('Delivery creation detected via storage event');
            refreshDeliveryPersonsData();
        }
    });
    
    // Listen for custom delivery creation events
    window.addEventListener('deliveryCreated', function(e) {
        console.log('Delivery creation detected via custom event');
        refreshDeliveryPersonsData();
    });
    
    // Periodic check for delivery creation (fallback)
    setInterval(checkForDeliveryCreation, 5000); // Check every 5 seconds
    
    // Add event listener for pending delivery selection
    document.getElementById('pendingDeliveryInput').addEventListener('change', updateReassignButtons);
    
    // Add event listener for unassigned delivery selection
    document.getElementById('unassignedDeliveryInput').addEventListener('change', function() {
        const selectedValue = this.value;
        const quickActionsContainer = document.getElementById('quickActionsContainer');
        const toggleQuickActionsBtn = document.getElementById('toggleQuickActionsBtn');
        const toggleIcon = toggleQuickActionsBtn.querySelector('i');
        
        if (selectedValue && selectedValue !== '') {
            // Auto-open the quick actions container when a delivery is selected
            quickActionsContainer.classList.remove('hidden');
            toggleIcon.classList.remove('fa-chevron-down');
            toggleIcon.classList.add('fa-chevron-up');
            toggleQuickActionsBtn.querySelector('span').textContent = 'Hide Actions';
        } else {
            // Optionally close when selection is cleared
            // quickActionsContainer.classList.add('hidden');
            // toggleIcon.classList.remove('fa-chevron-up');
            // toggleIcon.classList.add('fa-chevron-down');
            // toggleQuickActionsBtn.querySelector('span').textContent = 'Actions';
        }
    });
    
    // Toggle delivery persons section
    document.getElementById('toggleDeliveryPersons').addEventListener('click', function() {
        const content = document.getElementById('deliveryPersonsContent');
        const icon = document.getElementById('deliveryPersonsToggleIcon');
        
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            refreshDeliveryPersons();
        } else {
            content.classList.add('hidden');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    });
    
    // Toggle recent deliveries section
    document.getElementById('toggleDeliveries').addEventListener('click', function() {
        const content = document.getElementById('recentDeliveries');
        const icon = document.getElementById('toggleIcon');
        const filter = document.getElementById('recentDeliveriesFilter');
        
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            filter.classList.remove('hidden');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            fetchRecentDeliveries();
        } else {
            content.classList.add('hidden');
            filter.classList.add('hidden');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    });
    
    // Load initial data
    fetchRecentDeliveries();
});

// Format local date time function (shows full date and time)
function formatLocalDateTime(dateString) {
    if (!dateString) return "Unknown";
    
    try {
        // Parse ISO string as local time to prevent double UTC conversion
        let createdDate;
        if (dateString.includes('T') && dateString.includes(':')) {
            const [datePart, timePart] = dateString.split('T');
            const [year, month, day] = datePart.split('-').map(Number);
            const [hours, minutes, seconds] = timePart.split(':').map(Number);
            // Create as local time (no timezone conversion)
            createdDate = new Date(year, month - 1, day, hours, minutes, seconds || 0);
        } else {
            createdDate = new Date(dateString);
        }
        
        // Format to show full date and time: MM/DD/YYYY, HH:MM:SS AM/PM
        const month = String(createdDate.getMonth() + 1).padStart(2, '0');
        const day = String(createdDate.getDate()).padStart(2, '0');
        const year = createdDate.getFullYear();
        const hours = String(createdDate.getHours()).padStart(2, '0');
        const minutes = String(createdDate.getMinutes()).padStart(2, '0');
        const seconds = String(createdDate.getSeconds()).padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
        
        const dateTimeString = `${month}/${day}/${year}, ${displayHours}:${minutes}:${seconds} ${ampm}`;
        
        return dateTimeString;
    } catch (e) {
        return "Unknown";
    }
}

// Time ago function (matches dashboard get_time_ago)
function getTimeAgo(dateString) {
    if (!dateString) return "Unknown";
    
    try {
        // Parse ISO string as local time to prevent double UTC conversion
        let createdDate;
        if (dateString.includes('T') && dateString.includes(':')) {
            const [datePart, timePart] = dateString.split('T');
            const [year, month, day] = datePart.split('-').map(Number);
            const [hours, minutes, seconds] = timePart.split(':').map(Number);
            // Create as local time (no timezone conversion)
            createdDate = new Date(year, month - 1, day, hours, minutes, seconds || 0);
        } else {
            createdDate = new Date(dateString);
        }
        
        const now = new Date();
        const diff = now - createdDate;
        
        if (diff < 0) return "Just now";
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        if (days > 0) {
            return `${days} day${days > 1 ? 's' : ''} ago`;
        } else if (hours > 0) {
            return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        } else if (minutes > 0) {
            return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        } else {
            return "Just now";
        }
    } catch (e) {
        return "Unknown";
    }
}

// Format date in browser local time
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        const date = new Date(dateString);
        // Use browser's local time for consistent display with current time
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
    } catch (error) {
        return 'Invalid date';
    }
}

// Filter functions
window.filterRecentDeliveries = function(period) {
    currentFilters.period = period;
    
    // Update button styles
    document.querySelectorAll('.recent-filter-btn').forEach(btn => {
        if (btn.dataset.period === period) {
            btn.classList.remove('bg-gray-50', 'border-gray-200', 'text-gray-700');
            btn.classList.add('bg-blue-600', 'border-blue-600', 'text-white', 'shadow-sm');
        } else {
            btn.classList.remove('bg-blue-600', 'border-blue-600', 'text-white', 'shadow-sm');
            btn.classList.add('bg-gray-50', 'border-gray-200', 'text-gray-700');
        }
    });
    
    // Update charts based on period
    if (period === 'today') {
        // Update status distribution for today
        updateStatusDistributionForPeriod('today');
        // Update delivery trends for 1 day
        updateDeliveryTrendsForPeriod(1);
    } else if (period === 'week') {
        updateStatusDistributionForPeriod('week');
        updateDeliveryTrendsForPeriod(7);
    } else if (period === 'month') {
        updateStatusDistributionForPeriod('month');
        updateDeliveryTrendsForPeriod(30);
    } else if (period === 'year') {
        updateStatusDistributionForPeriod('year');
        updateDeliveryTrendsForPeriod(90);
    } else {
        // Default to 30 days
        updateStatusDistributionForPeriod('month');
        updateDeliveryTrendsForPeriod(30);
    }
    
    applyCombinedFilters();
};

// Update charts for specific periods
window.updateStatusDistributionForPeriod = function(period) {
    let days = 30; // default
    if (period === 'today') days = 1;
    else if (period === 'week') days = 7;
    else if (period === 'month') days = 30;
    else if (period === 'year') days = 365;
    
    fetch(`/get_status_distribution?days=${days}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading status distribution:', data.error);
                return;
            }
            
            // Update status distribution chart
            const statusCanvas = document.getElementById('statusDistributionChart');
            if (statusCanvas && data.labels && data.data) {
                const ctx = statusCanvas.getContext('2d');
                
                // Destroy existing chart if it exists
                if (window.statusDistributionChartInstance) {
                    window.statusDistributionChartInstance.destroy();
                }
                
                // Create new chart
                window.statusDistributionChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.data,
                            backgroundColor: [
                                'rgba(255, 206, 86, 0.8)',  // Yellow for Pending
                                'rgba(54, 162, 235, 0.8)', // Blue for In Transit
                                'rgba(75, 192, 192, 0.8)'  // Green for Delivered
                            ],
                            borderColor: [
                                'rgba(255, 206, 86, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(75, 192, 192, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => console.error('Error fetching status distribution:', error));
};

window.updateDeliveryTrendsForPeriod = function(days) {
    fetch(`/get_delivery_trends?days=${days}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading delivery trends:', data.error);
                return;
            }
            
            // Update delivery trends chart using existing chart system
            const trendsCanvas = document.getElementById('deliveryTrendsChart');
            if (trendsCanvas && data.dates) {
                // Update the trends chart with new data
                if (typeof updateDeliveryTrends === 'function') {
                    // Call the existing function which will fetch fresh data
                    updateDeliveryTrends();
                } else {
                    // Fallback: manually update the chart if the function doesn't exist
                    console.log('Delivery trends data:', data);
                }
            }
        })
        .catch(error => console.error('Error fetching delivery trends:', error));
};

window.filterRecentDeliveriesByStatus = function(status) {
    currentFilters.status = status;
    
    // Update button styles
    document.querySelectorAll('.status-filter-btn').forEach(btn => {
        if (btn.dataset.status === status) {
            btn.classList.remove('bg-gray-50', 'border-gray-200', 'text-gray-700');
            btn.classList.add('bg-blue-600', 'border-blue-600', 'text-white', 'shadow-sm');
        } else {
            btn.classList.remove('bg-blue-600', 'border-blue-600', 'text-white', 'shadow-sm');
            btn.classList.add('bg-gray-50', 'border-gray-200', 'text-gray-700');
        }
    });
    
    applyCombinedFilters();
};

window.filterRecentDeliveriesBySearch = function(searchTerm) {
    currentFilters.search = searchTerm.toLowerCase().trim();
    applyCombinedFilters();
};

window.clearAllFilters = function() {
    currentFilters = {
        period: 'all',
        status: 'all',
        search: ''
    };
    
    // Reset all button styles
    document.querySelectorAll('.recent-filter-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'border-blue-600', 'text-white', 'shadow-sm');
        btn.classList.add('bg-gray-50', 'border-gray-200', 'text-gray-700');
    });
    
    document.querySelectorAll('.status-filter-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'border-blue-600', 'text-white', 'shadow-sm');
        btn.classList.add('bg-gray-50', 'border-gray-200', 'text-gray-700');
    });
    
    // Clear search input
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.value = '';
        applyCombinedFilters();
    }
};

// Apply combined filters
function applyCombinedFilters() {
    const tbody = document.getElementById('recentDeliveriesBody');
    const rows = tbody.querySelectorAll('tr');
    const resultsCountElement = document.getElementById('searchResultsCount');
    const resultsCountSpan = document.getElementById('resultsCount');
    
    let visibleCount = 0;
    
    // Parse date filters
    let startDate = null;
    let endDate = null;
    
    if (currentFilters.period !== 'all') {
        const now = new Date();
        switch (currentFilters.period) {
            case 'today':
                startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(now);
                endDate.setHours(23, 59, 59, 999);
                break;
            case 'week':
                startDate = new Date(now);
                startDate.setDate(now.getDate() - now.getDay());
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                endDate.setHours(23, 59, 59, 999);
                break;
            case 'month':
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                endDate.setHours(23, 59, 59, 999);
                break;
            case 'year':
                startDate = new Date(now.getFullYear(), 0, 1);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(now.getFullYear(), 11, 31);
                endDate.setHours(23, 59, 59, 999);
                break;
        }
    }
    
    rows.forEach(row => {
        let shouldShow = true;
        
        // Check date filter
        if (startDate && endDate) {
            const dateText = row.querySelector('td:nth-child(8)').textContent.trim();
            const rowDate = new Date(dateText);
            if (rowDate < startDate || rowDate > endDate) {
                shouldShow = false;
            }
        }
        
        // Check status filter
        if (shouldShow && currentFilters.status !== 'all') {
            const statusElement = row.querySelector('td:nth-child(7) span');
            const rowStatus = statusElement ? statusElement.textContent.trim() : '';
            if (rowStatus !== currentFilters.status) {
                shouldShow = false;
            }
        }
        
        // Check search filter
        if (shouldShow && currentFilters.search !== '') {
            const term = currentFilters.search.toLowerCase();
            const deliveryId = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
            const displayId = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const sender = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            const recipient = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
            const deliveryAddress = row.querySelector('td:nth-child(5)').textContent.toLowerCase();
            const deliveryPerson = row.querySelector('td:nth-child(6)').textContent.toLowerCase();
            const status = row.querySelector('td:nth-child(7) span').textContent.toLowerCase();
            const date = row.querySelector('td:nth-child(8)').textContent.toLowerCase();
            
            const matchesSearch = deliveryId.includes(term) || displayId.includes(term) || 
                                sender.includes(term) || recipient.includes(term) || 
                                deliveryAddress.includes(term) || deliveryPerson.includes(term) || 
                                status.includes(term) || date.includes(term);
            
            if (!matchesSearch) {
                shouldShow = false;
            }
        }
        
        // Apply visibility
        if (shouldShow) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update results count
    if (resultsCountElement && resultsCountSpan) {
        if (currentFilters.search !== '' || currentFilters.period !== 'all' || currentFilters.status !== 'all') {
            resultsCountElement.classList.remove('hidden');
            resultsCountSpan.textContent = visibleCount;
        } else {
            resultsCountElement.classList.add('hidden');
        }
    }
    
    updateActiveFilters();
    renumberVisibleRows();
};

// Export Recent Deliveries to CSV
window.exportRecentDeliveriesToCSV = function() {
    // Show loading state
    const exportBtn = document.getElementById('exportCSVBtn');
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
    exportBtn.disabled = true;
    
    // Build API URL with current filters
    let apiUrl = '/get_recent_deliveries?per_page=10000'; // Large number to get all records
    
    // Add period filter if not 'all'
    if (currentFilters.period !== 'all') {
        apiUrl += `&period=${currentFilters.period}`;
    }
    
    // Add status filter if not 'all'
    if (currentFilters.status !== 'all') {
        apiUrl += `&status=${currentFilters.status}`;
    }
    
    // Add search filter if present
    if (currentFilters.search) {
        apiUrl += `&search=${encodeURIComponent(currentFilters.search)}`;
    }
    
    // Fetch all filtered data from backend
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            let deliveries = [];
            
            // Handle different response formats
            if (data.deliveries && Array.isArray(data.deliveries)) {
                deliveries = data.deliveries;
            } else if (Array.isArray(data)) {
                deliveries = data;
            }
            
            // Apply client-side filtering if needed (for period filtering)
            if (currentFilters.period !== 'all') {
                deliveries = filterDeliveriesByPeriod(deliveries, currentFilters.period);
            }
            
            // Apply client-side status filtering
            if (currentFilters.status !== 'all') {
                deliveries = deliveries.filter(delivery => 
                    delivery.status === currentFilters.status
                );
            }
            
            // Apply client-side search filtering
            if (currentFilters.search) {
                const searchTerm = currentFilters.search.toLowerCase();
                deliveries = deliveries.filter(delivery => {
                    return (
                        (delivery.display_id && delivery.display_id.toLowerCase().includes(searchTerm)) ||
                        (delivery.sender_name && delivery.sender_name.toLowerCase().includes(searchTerm)) ||
                        (delivery.sender_phone && delivery.sender_phone.toLowerCase().includes(searchTerm)) ||
                        (delivery.recipient_name && delivery.recipient_name.toLowerCase().includes(searchTerm)) ||
                        (delivery.recipient_phone && delivery.recipient_phone.toLowerCase().includes(searchTerm)) ||
                        (delivery.recipient_address && delivery.recipient_address.toLowerCase().includes(searchTerm)) ||
                        (delivery.delivery_person && delivery.delivery_person.toLowerCase().includes(searchTerm)) ||
                        (delivery.payment_by && delivery.payment_by.toLowerCase().includes(searchTerm))
                    );
                });
            }
            
            if (deliveries.length === 0) {
                alert('No deliveries found matching your filters.');
                // Reset button state
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
                return;
            }
            
            // Define CSV headers
            const headers = [
                'Ref #',
                'Display ID', 
                'Sender Name',
                'Sender Phone',
                'Recipient Name',
                'Recipient Phone',
                'Delivery Address',
                'Delivery Person',
                'Pickup',
                'Amount',
                'Status',
                'Date',
                'Time Ago'
            ];
            
            // Convert deliveries data to CSV
            const csvData = [];
            csvData.push(headers.join(','));
            
            deliveries.forEach((delivery, index) => {
                const rowData = [];
                
                // Extract data from delivery object
                rowData.push('"' + (index + 1) + '"'); // Ref #
                rowData.push('"' + (delivery.display_id || '') + '"'); // Display ID
                rowData.push('"' + (delivery.sender_name || '') + '"'); // Sender Name
                rowData.push('"' + (delivery.sender_phone || '') + '"'); // Sender Phone
                rowData.push('"' + (delivery.recipient_name || '') + '"'); // Recipient Name
                rowData.push('"' + (delivery.recipient_phone || '') + '"'); // Recipient Phone
                rowData.push('"' + (delivery.recipient_address || '') + '"'); // Delivery Address
                rowData.push('"' + (delivery.delivery_person || '') + '"'); // Delivery Person
                rowData.push('"' + (delivery.payment_by || '') + '"'); // Pickup
                rowData.push('"' + (delivery.amount ? delivery.amount.toFixed(2) : '0.00') + '"'); // Amount
                rowData.push('"' + (delivery.status || '') + '"'); // Status
                
                // Format date
                let dateText = '';
                let timeAgoText = '';
                if (delivery.created_at) {
                    const createdDate = new Date(delivery.created_at);
                    dateText = createdDate.toLocaleDateString() + ' ' + createdDate.toLocaleTimeString();
                    timeAgoText = delivery.time_ago || getTimeAgo(createdDate);
                }
                rowData.push('"' + dateText + '"'); // Date
                rowData.push('"' + timeAgoText + '"'); // Time Ago
                
                csvData.push(rowData.join(','));
            });
            
            // Create CSV content
            const csvContent = csvData.join('\n');
            
            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Generate filename with timestamp and filter info
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
            let filename = `recent_deliveries_${timestamp}.csv`;
            
            // Add filter info to filename if filters are active
            const filterParts = [];
            if (currentFilters.period !== 'all') filterParts.push(currentFilters.period);
            if (currentFilters.status !== 'all') filterParts.push(currentFilters.status);
            if (currentFilters.search) filterParts.push('search');
            
            if (filterParts.length > 0) {
                filename = `recent_deliveries_${filterParts.join('_')}_${timestamp}.csv`;
            }
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message with count
            exportBtn.innerHTML = `<i class="fas fa-check mr-2"></i>Exported ${deliveries.length}!`;
            exportBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            exportBtn.classList.add('bg-green-500');
            
            setTimeout(() => {
                exportBtn.innerHTML = originalText;
                exportBtn.classList.remove('bg-green-500');
                exportBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                exportBtn.disabled = false;
            }, 2000);
        })
        .catch(error => {
            console.error('Error exporting deliveries:', error);
            alert('Error exporting deliveries. Please try again.');
            // Reset button state
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        });
};

// Toggle Daily Deliveries section
window.toggleDailyDeliveries = function(button) {
    const content = button.closest('.mt-3').querySelector('.daily-deliveries-content');
    const expandText = button.querySelector('.expand-text');
    const collapseText = button.querySelector('.collapse-text');
    const previewContent = content.querySelector('.space-y-1:not(.daily-deliveries-full)');
    const fullContent = content.querySelector('.daily-deliveries-full');
    const moreDaysText = content.querySelector('.text-gray-500.italic');
    
    if (fullContent.classList.contains('hidden')) {
        // Show full content
        previewContent.classList.add('hidden');
        fullContent.classList.remove('hidden');
        expandText.classList.add('hidden');
        collapseText.classList.remove('hidden');
        if (moreDaysText) {
            moreDaysText.classList.add('hidden');
        }
    } else {
        // Show preview content
        previewContent.classList.remove('hidden');
        fullContent.classList.add('hidden');
        expandText.classList.remove('hidden');
        collapseText.classList.add('hidden');
        if (moreDaysText) {
            moreDaysText.classList.remove('hidden');
        }
    }
};

// Toggle Delivery Summary section
window.toggleDeliverySummary = function() {
    const summarySection = document.getElementById('deliverySummarySection');
    const summaryBtn = document.querySelector('.summary-toggle-btn');
    const summaryText = summaryBtn.querySelector('.summary-text');
    
    if (summarySection.classList.contains('hidden')) {
        // Show summary
        summarySection.classList.remove('hidden');
        summaryText.textContent = 'Hide Summary';
        loadDeliverySummary();
    } else {
        // Hide summary
        summarySection.classList.add('hidden');
        summaryText.textContent = 'Show Summary';
    }
};

// Load and display delivery summary
window.loadDeliverySummary = function() {
    const summaryContent = document.getElementById('summaryContent');
    
    // Show loading state
    summaryContent.innerHTML = `
        <div class="col-span-3 text-center py-4">
            <i class="fas fa-spinner fa-spin text-purple-400 text-xl mb-2"></i>
            <p class="text-sm text-gray-500">Loading summary...</p>
        </div>
    `;
    
    // Fetch delivery persons data
    fetch('/get_delivery_persons?period=all')
        .then(response => response.json())
        .then(persons => {
            displayDeliverySummary(persons);
        })
        .catch(error => {
            console.error('Error loading delivery summary:', error);
            summaryContent.innerHTML = `
                <div class="col-span-3 text-center py-4">
                    <i class="fas fa-exclamation-triangle text-red-400 text-xl mb-2"></i>
                    <p class="text-sm text-gray-500">Error loading summary</p>
                </div>
            `;
        });
};

// Display delivery summary with day/week/month totals
window.displayDeliverySummary = function(persons) {
    const summaryContent = document.getElementById('summaryContent');
    
    if (persons.length === 0) {
        summaryContent.innerHTML = `
            <div class="col-span-3 text-center py-4">
                <i class="fas fa-users text-gray-300 text-xl mb-2"></i>
                <p class="text-sm text-gray-500">No delivery persons found</p>
            </div>
        `;
        return;
    }
    
    // Calculate summaries for each period
    const todaySummary = calculatePeriodSummary(persons, 'today');
    const weekSummary = calculatePeriodSummary(persons, 'week');
    const monthSummary = calculatePeriodSummary(persons, 'month');
    
    summaryContent.innerHTML = `
        <!-- Today Summary -->
        <div class="bg-white rounded-lg p-4 border border-purple-200">
            <div class="flex items-center mb-3">
                <i class="fas fa-calendar-day text-purple-500 mr-2"></i>
                <h4 class="font-semibold text-gray-800">Today's Summary</h4>
            </div>
            <div class="space-y-2">
                ${todaySummary.map(person => `
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">${person.name}:</span>
                        <span class="font-medium text-purple-600">${person.deliveries} delivered</span>
                    </div>
                `).join('')}
                ${todaySummary.length === 0 ? '<p class="text-xs text-gray-500 italic">No deliveries today</p>' : ''}
            </div>
        </div>
        
        <!-- Week Summary -->
        <div class="bg-white rounded-lg p-4 border border-blue-200">
            <div class="flex items-center mb-3">
                <i class="fas fa-calendar-week text-blue-500 mr-2"></i>
                <h4 class="font-semibold text-gray-800">This Week</h4>
            </div>
            <div class="space-y-2">
                ${weekSummary.map(person => `
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">${person.name}:</span>
                        <span class="font-medium text-blue-600">${person.deliveries} delivered</span>
                    </div>
                `).join('')}
                ${weekSummary.length === 0 ? '<p class="text-xs text-gray-500 italic">No deliveries this week</p>' : ''}
            </div>
        </div>
        
        <!-- Month Summary -->
        <div class="bg-white rounded-lg p-4 border border-green-200">
            <div class="flex items-center mb-3">
                <i class="fas fa-calendar-alt text-green-500 mr-2"></i>
                <h4 class="font-semibold text-gray-800">This Month</h4>
            </div>
            <div class="space-y-2">
                ${monthSummary.map(person => `
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">${person.name}:</span>
                        <span class="font-medium text-green-600">${person.deliveries} delivered</span>
                    </div>
                `).join('')}
                ${monthSummary.length === 0 ? '<p class="text-xs text-gray-500 italic">No deliveries this month</p>' : ''}
            </div>
        </div>
    `;
};

// Calculate summary for a specific period (count only delivered deliveries)
window.calculatePeriodSummary = function(persons, period) {
    const summary = {};
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    persons.forEach(person => {
        if (person.daily_deliveries) {
            let deliveredCount = 0;
            
            Object.entries(person.daily_deliveries).forEach(([date, deliveries]) => {
                const deliveryDate = new Date(date + 'T00:00:00');
                let includeDelivery = false;
                
                if (period === 'today') {
                    includeDelivery = deliveryDate.toDateString() === today.toDateString();
                } else if (period === 'week') {
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    includeDelivery = deliveryDate >= weekStart && deliveryDate <= weekEnd;
                } else if (period === 'month') {
                    includeDelivery = deliveryDate.getMonth() === today.getMonth() && 
                                   deliveryDate.getFullYear() === today.getFullYear();
                }
                
                if (includeDelivery) {
                    // Count only delivered deliveries
                    deliveredCount += deliveries.filter(d => 
                        d.status === 'Delivered' || d.status === 'delivered'
                    ).length;
                }
            });
            
            if (deliveredCount > 0) {
                summary[person.name] = deliveredCount;
            }
        }
    });
    
    // Convert to array and sort by delivered count (descending)
    return Object.entries(summary)
        .map(([name, deliveries]) => ({ name, deliveries }))
        .sort((a, b) => b.deliveries - a.deliveries);
};

// Functions for the new Expense & Delivery Person Assignment Card (Simplified)
window.updateDeliveryExpensesAndPerson = function() {
    const deliveryId = getSelectedDeliveryId();
    const expenses = document.getElementById('expensesInput').value;
    const deliveryPerson = document.getElementById('deliveryPersonInput').value.trim();
    
    if (!deliveryId) {
        showNotification('Please select a delivery ID', 'error');
        return;
    }
    
    const data = {
        delivery_id: deliveryId,
        expenses: parseFloat(expenses) || 0,
        delivery_person: deliveryPerson
    };
    
    fetch('/update_delivery_expenses_and_person', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.status === 404) {
            // Try alternative endpoint
            return fetch('/update_delivery', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
        }
        return response;
    })
    .then(response => {
        if (!response.ok) {
            // Don't throw error for 404, let the JSON response handle it
            return response.json().then(json => {
                throw new Error(json.error || `HTTP ${response.status}`);
            });
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            showNotification('Delivery updated successfully!', 'success');
            clearDeliveryForm();
            
            // Update all relevant parts with proper sequencing
            setTimeout(() => {
                // First refresh summary data (charts and cards)
                fetchSummaryData().then(() => {
                    // Then update dashboard with current period
                    updateDashboard(currentPeriod);
                });
                
                // Refresh dropdown (assigned delivery should disappear)
                loadUnassignedDeliveries();
                
                // Refresh delivery persons dropdown (new person should appear)
                loadDeliveryPersonsDropdown();
                
                // Refresh delivery persons section
                fetchDeliveryPersons(currentPeriod);
                
                // Refresh recent deliveries table
                fetchRecentDeliveriesWithFilter();
                
                // Show additional notification for comprehensive update
                setTimeout(() => {
                    showNotification('All sections updated!', 'success');
                }, 500);
            }, 300); // Small delay to ensure backend processing
        } else {
            showNotification(result.message || result.error || 'Error updating delivery', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification(error.message || 'Error updating delivery', 'error');
    });
};

window.clearDeliveryForm = function() {
    document.getElementById('unassignedDeliveryInput').value = '';
    document.getElementById('pendingDeliveryInput').value = '';
    document.getElementById('deliveryPersonInput').value = '';
    document.getElementById('deliveryPersonSelect').value = '';
};

// Simple quick reassign function - uses existing data only
window.quickReassign = function(personName) {
    const deliveryId = getSelectedDeliveryId();
    
    if (!deliveryId) {
        showNotification('Please select a delivery first', 'error');
        return;
    }
    
    // Get delivery details to check status
    fetch(`/get_delivery_by_display_id/${deliveryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showNotification('Error loading delivery details', 'error');
                return;
            }
            
            // Check if delivery is pending
            if (data.status !== 'Pending' && data.status !== 'pending') {
                showNotification('Only pending deliveries can be reassigned', 'error');
                return;
            }
            
            // Use existing data - only change delivery person
            const requestData = {
                delivery_id: deliveryId,
                delivery_person: personName
                // Don't send expenses or amount - preserve existing values
            };
            
            showNotification(`Reassigning to ${personName}...`, 'info');
            
            fetch('/update_delivery_expenses_and_person', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification(`Delivery reassigned to ${personName}!`, 'success');
                    clearDeliveryForm();
                    
                    // Refresh all data to reflect reassignment
                    setTimeout(() => {
                        loadUnassignedDeliveries();
                        loadPendingDeliveries();
                        loadAvailableDeliveryPersons(); // Refresh available persons
                        fetchDeliveryPersons(currentPeriod);
                        fetchRecentDeliveries();
                        fetchSummaryData().then(() => {
                            updateDashboard(currentPeriod);
                        });
                    }, 300);
                } else {
                    showNotification(result.error || 'Error reassigning delivery', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error reassigning delivery', 'error');
            });
        })
        .catch(error => {
            console.error('Error checking delivery status:', error);
            showNotification('Error checking delivery status', 'error');
        });
};

// Load existing delivery persons for dropdown
window.loadDeliveryPersonsDropdown = function() {
    const select = document.getElementById('deliveryPersonSelect');
    
    fetch('/get_delivery_persons?period=all')
        .then(response => response.json())
        .then(persons => {
            // Clear existing options except the first one
            select.innerHTML = '<option value="">Select existing delivery person...</option>';
            
            if (persons.length === 0) {
                select.innerHTML += '<option value="" disabled>No existing delivery persons found</option>';
                return;
            }
            
            // Add unique delivery persons to dropdown
            const uniquePersons = [...new Set(persons.map(p => p.name))];
            uniquePersons.sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading delivery persons:', error);
            select.innerHTML = '<option value="" disabled>Error loading delivery persons</option>';
        });
};


// Handle dropdown selection to auto-fill text input
document.addEventListener('DOMContentLoaded', function() {
    const deliveryPersonSelect = document.getElementById('deliveryPersonSelect');
    const deliveryPersonInput = document.getElementById('deliveryPersonInput');
    
    if (deliveryPersonSelect && deliveryPersonInput) {
        deliveryPersonSelect.addEventListener('change', function() {
            if (this.value) {
                deliveryPersonInput.value = this.value;
            }
        });
        
        // Clear dropdown when typing in text input
        deliveryPersonInput.addEventListener('input', function() {
            if (this.value !== deliveryPersonSelect.value) {
                deliveryPersonSelect.value = '';
            }
        });
    }
});
// Tab switching function
window.showDeliveryType = function(type) {
    const unassignedTab = document.getElementById('unassignedTab');
    const pendingTab = document.getElementById('pendingTab');
    const unassignedSection = document.getElementById('unassignedSection');
    const pendingSection = document.getElementById('pendingSection');
    const updateFields = document.getElementById('updateFields');
    const reassignSection = document.getElementById('reassignSection');
    
    if (type === 'unassigned') {
        // Show unassigned tab
        unassignedTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        unassignedTab.classList.remove('text-gray-500');
        pendingTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        pendingTab.classList.add('text-gray-500');
        
        unassignedSection.classList.remove('hidden');
        pendingSection.classList.add('hidden');
        updateFields.classList.remove('hidden'); // Show update fields
        reassignSection.classList.add('hidden'); // Hide reassign section
    } else {
        // Show pending tab
        pendingTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        pendingTab.classList.remove('text-gray-500');
        unassignedTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        unassignedTab.classList.add('text-gray-500');
        
        pendingSection.classList.remove('hidden');
        unassignedSection.classList.add('hidden');
        updateFields.classList.add('hidden'); // Hide update fields
        reassignSection.classList.remove('hidden'); // Show reassign section
    }
};

// Load unassigned deliveries
window.loadUnassignedDeliveries = function() {
    const select = document.getElementById('unassignedDeliveryInput');
    
    fetch('/get_unassigned_deliveries')
        .then(response => response.json())
        .then(deliveries => {
            select.innerHTML = '<option value="">Select unassigned delivery...</option>';
            
            if (!Array.isArray(deliveries) || deliveries.length === 0) {
                select.innerHTML += '<option value="" disabled>No unassigned deliveries found</option>';
                return;
            }
            
            deliveries.forEach(delivery => {
                const option = document.createElement('option');
                option.value = delivery.display_id;
                option.textContent = `${delivery.display_id} - ${delivery.sender_name}  ${delivery.recipient_name} (${delivery.created_at})`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading unassigned deliveries:', error);
            select.innerHTML = '<option value="">Select unassigned delivery...</option><option value="" disabled>Error loading deliveries</option>';
        });
};

// Load pending deliveries
window.loadPendingDeliveries = function() {
    const select = document.getElementById('pendingDeliveryInput');
    
    fetch('/get_recent_deliveries')
        .then(response => response.json())
        .then(data => {
            select.innerHTML = '<option value="">Select pending delivery...</option>';
            
            // Extract deliveries array from the response
            const deliveries = data.deliveries || [];
            
            if (!Array.isArray(deliveries) || deliveries.length === 0) {
                select.innerHTML += '<option value="" disabled>No pending deliveries found</option>';
                return;
            }
            
            // Filter for pending deliveries only
            const pendingDeliveries = deliveries.filter(delivery => 
                delivery.status === 'Pending' || delivery.status === 'pending'
            );
            
            if (pendingDeliveries.length === 0) {
                select.innerHTML += '<option value="" disabled>No pending deliveries found</option>';
                return;
            }
            
            pendingDeliveries.forEach(delivery => {
                const option = document.createElement('option');
                option.value = delivery.display_id;
                const statusInfo = delivery.delivery_person ? ` (${delivery.delivery_person})` : ' (unassigned)';
                option.textContent = `${delivery.display_id} - ${delivery.sender_name}  ${delivery.recipient_name}${statusInfo}`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading pending deliveries:', error);
            select.innerHTML = '<option value="">Select pending delivery...</option><option value="" disabled>Error loading deliveries</option>';
        });
};

// Load all available delivery persons for reassign buttons
window.loadAvailableDeliveryPersons = function() {
    fetch('/get_delivery_persons?period=all')
        .then(response => response.json())
        .then(persons => {
            if (!Array.isArray(persons) || persons.length === 0) {
                document.getElementById('reassignButtons').innerHTML = '<p class="text-xs text-gray-500">No delivery persons available</p>';
                return;
            }
            
            // Extract unique delivery person names
            const uniquePersons = persons.map(p => p.name).filter((name, index, self) => self.indexOf(name) === index);
            uniquePersons.sort();
            
            // Store for later use
            window.allDeliveryPersons = uniquePersons;
            
            // Update buttons if a delivery is selected
            updateReassignButtons();
        })
        .catch(error => {
            console.error('Error loading delivery persons:', error);
            document.getElementById('reassignButtons').innerHTML = '<p class="text-xs text-red-500">Error loading delivery persons</p>';
        });
};

// Update reassign buttons based on selected delivery
window.updateReassignButtons = function() {
    const deliveryId = document.getElementById('pendingDeliveryInput').value;
    const buttonsContainer = document.getElementById('reassignButtons');
    
    if (!deliveryId || !window.allDeliveryPersons) {
        buttonsContainer.innerHTML = '<p class="text-xs text-gray-500">Select pending delivery to show available persons</p>';
        return;
    }
    
    // Get current delivery details to find assigned person
    fetch('/get_recent_deliveries')
        .then(response => response.json())
        .then(deliveries => {
            const selectedDelivery = deliveries.find(d => d.display_id === deliveryId);
            const currentPerson = selectedDelivery?.delivery_person;
            
            // Filter out current person and create buttons
            const availablePersons = window.allDeliveryPersons.filter(person => person !== currentPerson);
            
            if (availablePersons.length === 0) {
                buttonsContainer.innerHTML = '<p class="text-xs text-gray-500">No other delivery persons available</p>';
                return;
            }
            
            // Generate buttons with help text
            const buttonsHtml = availablePersons.map(person => 
                `<button onclick="quickReassign('${person}')" 
                        class="bg-green-600 text-white px-3 py-1 text-xs font-medium rounded hover:bg-green-700 transition-colors">
                    ${person}
                </button>`
            ).join('');
            
            const helpText = currentPerson 
                ? `<p class="text-xs text-gray-500 mt-2">Currently assigned to ${currentPerson}. Click to reassign to another person.</p>`
                : `<p class="text-xs text-gray-500 mt-2">Click to assign to a delivery person.</p>`;
            
            buttonsContainer.innerHTML = buttonsHtml + helpText;
        })
        .catch(error => {
            console.error('Error getting delivery details:', error);
            buttonsContainer.innerHTML = '<p class="text-xs text-red-500">Error loading delivery details</p>';
        });
};

// Get selected delivery ID from active tab
window.getSelectedDeliveryId = function() {
    const unassignedSection = document.getElementById('unassignedSection');
    const pendingSection = document.getElementById('pendingSection');
    
    if (!unassignedSection.classList.contains('hidden')) {
        return document.getElementById('unassignedDeliveryInput').value;
    } else {
        return document.getElementById('pendingDeliveryInput').value;
    }
};

// Notification function
window.showNotification = function(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
    
    // Set color based on type
    if (type === 'success') {
        notification.classList.add('bg-green-500', 'text-white');
    } else if (type === 'error') {
        notification.classList.add('bg-red-500', 'text-white');
    } else {
        notification.classList.add('bg-blue-500', 'text-white');
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
};

// User Management Functions
window.loadUsers = function() {
    fetch('/get_users')
        .then(response => response.json())
        .then(users => {
            const usersList = document.getElementById('usersList');
            if (users.length === 0) {
                usersList.innerHTML = '<p class="text-gray-500 text-sm">No users found</p>';
                return;
            }
            
            const usersHtml = users.map(user => `
                <div class="flex items-center justify-between py-1 px-2 bg-gray-50 rounded hover:bg-gray-100 transition-colors">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-xs font-bold">${user.username[0].toUpperCase()}</span>
                        </div>
                        <div>
                            <div class="text-xs font-medium text-gray-800">${user.username}</div>
                            <div class="text-xs text-gray-500">${user.role}</div>
                        </div>
                    </div>
                    ${user.username !== 'Admin' ? `
                        <div class="flex items-center gap-1">
                            <button onclick="editNewUser(${user.id}, '${user.username}', '${user.role}')" 
                                    class="text-blue-600 hover:bg-blue-100 p-1 rounded transition-colors"
                                    title="Edit">
                                <i class="fas fa-edit text-xs"></i>
                            </button>
                            <button onclick="deleteUser(${user.id}, '${user.username}')" 
                                    class="text-red-600 hover:bg-red-100 p-1 rounded transition-colors"
                                    title="Delete">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    ` : '<span class="text-xs text-gray-400 font-medium">Admin</span>'}
                </div>
            `).join('');
            
            usersList.innerHTML = usersHtml;
        })
        .catch(error => {
            console.error('Error loading users:', error);
            document.getElementById('usersList').innerHTML = '<p class="text-red-500 text-sm">Error loading users</p>';
        });
};


window.deleteUser = function(userId, username) {
    if (confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
        fetch(`/delete_user/${userId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification('User deleted successfully', 'success');
                    loadUsers();
                } else {
                    showNotification(result.error || 'Error deleting user', 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                showNotification('Error deleting user', 'error');
            });
    }
};



window.toggleUsersList = function() {
    const container = document.getElementById('usersListContainer');
    const toggleBtn = document.getElementById('toggleUsersBtn');
    const icon = toggleBtn.querySelector('i');
    
    if (container.classList.contains('hidden')) {
        container.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
        // Load users only when first opened
        if (container.dataset.loaded !== 'true') {
            loadUsers();
            container.dataset.loaded = 'true';
        }
    } else {
        container.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
    }
};

window.toggleQuickActions = function() {
    const container = document.getElementById('quickActionsContainer');
    const toggleBtn = document.getElementById('toggleQuickActionsBtn');
    const icon = toggleBtn.querySelector('i');
    
    if (container.classList.contains('hidden')) {
        container.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
        // Load delivery persons and other data when first opened
        if (container.dataset.loaded !== 'true') {
            loadDeliveryPersons();
            loadUnassignedDeliveries();
            loadPendingDeliveries();
            container.dataset.loaded = 'true';
        }
    } else {
        container.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
    }
};

// Load users on page load (only if admin)
document.addEventListener('DOMContentLoaded', function() {
    // Load new users system
    if (document.body.dataset.userRole === 'admin') {
        loadNewUsers();
    }
    
    // Initialize charts
    initializeCharts();
});

// Chart variables
let deliveryTrendsChart = null;
let revenueChart = null;
let revenuePieChart = null;

// Initialize all charts
window.initializeCharts = function() {
    updateDeliveryTrends();
};

// Update delivery trends chart
window.updateDeliveryTrends = function() {
    const period = document.getElementById('trendsPeriod').value;
    
    fetch(`/get_delivery_trends?days=${period}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading delivery trends:', data.error);
                return;
            }
            
            const ctx = document.getElementById('deliveryTrendsChart').getContext('2d');
            
            if (deliveryTrendsChart) {
                deliveryTrendsChart.destroy();
            }
            
            deliveryTrendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#333',
                            borderWidth: 1,
                            padding: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' deliveries';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                color: '#6b7280'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                color: '#6b7280',
                                stepSize: 1
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching delivery trends:', error);
        });
};



// Revenue Analytics Functions
let revenueAnalyticsChart = null;
let currentRevenuePeriod = 'daily';

// Set revenue period and update analytics
window.setRevenuePeriod = function(period) {
    currentRevenuePeriod = period;
    
    // Update button styles
    const buttons = {
        daily: document.getElementById('revenueDailyBtn'),
        weekly: document.getElementById('revenueWeeklyBtn'),
        monthly: document.getElementById('revenueMonthlyBtn')
    };
    
    Object.keys(buttons).forEach(key => {
        const btn = buttons[key];
        if (key === period) {
            btn.className = 'px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-200 bg-emerald-600 text-white';
        } else {
            btn.className = 'px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-200 text-gray-600 hover:text-gray-800';
        }
    });
    
    // Update date range display
    const dateRanges = {
        daily: 'Last 7 days',
        weekly: 'Last 5 weeks',
        monthly: 'Last 12 months'
    };
    document.getElementById('revenueDateRange').textContent = dateRanges[period];
    
    // Update revenue analytics
    updateRevenueAnalytics();
};

// Update revenue analytics data
window.updateRevenueAnalytics = function() {
    // Fetch real data from database
    fetch(`/get_revenue_analytics?period=${currentRevenuePeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading revenue analytics:', data.error);
                return;
            }
            
            // Update date range display
            const dateRangeElement = document.getElementById('revenueDateRange');
            if (dateRangeElement && data.date_range) {
                dateRangeElement.textContent = data.date_range.description;
            }
            
            // Update metrics with real data
            try {
                const totalElement = document.getElementById('totalRevenueAnalytics');
                const avgElement = document.getElementById('avgDailyRevenue');
                const peakElement = document.getElementById('peakRevenueDay');
                const peakNameElement = document.getElementById('peakDayName');
                const growthElement = document.getElementById('revenueGrowthRate');
                
                if (totalElement) totalElement.textContent = `KSh ${data.metrics.total_revenue.toLocaleString()}`;
                if (avgElement) avgElement.textContent = `KSh ${Math.round(data.metrics.avg_daily).toLocaleString()}`;
                if (peakElement) peakElement.textContent = `KSh ${data.metrics.peak_revenue.toLocaleString()}`;
                if (peakNameElement) peakNameElement.textContent = data.metrics.peak_label;
                if (growthElement) growthElement.textContent = data.metrics.growth_rate;
            } catch (error) {
                console.error('Error updating revenue metrics:', error);
            }
            
            // Update chart with real data
            try {
                updateRevenueAnalyticsChart({
                    labels: data.labels,
                    revenue: data.revenue,
                    target: data.target
                });
            } catch (error) {
                console.error('Error updating revenue chart:', error);
            }
        })
        .catch(error => {
            console.error('Error fetching revenue analytics:', error);
            // Fallback to ensure metrics remain visible
            ensureRevenueMetricsVisible();
        });
};

// Update revenue analytics chart
window.updateRevenueAnalyticsChart = function(data) {
    const ctx = document.getElementById('revenueAnalyticsChart');
    if (!ctx) {
        console.warn('Revenue analytics chart canvas not found');
        return;
    }
    
    // Clear any existing chart
    if (revenueAnalyticsChart) {
        revenueAnalyticsChart.destroy();
        revenueAnalyticsChart = null;
    }
    
    // Small delay to prevent visual glitch
    setTimeout(function() {
        try {
            revenueAnalyticsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: data.revenue,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Target',
                            data: data.target,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': KSh ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KSh ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        } catch (chartError) {
            console.error('Error creating revenue chart:', chartError);
        }
    }, 100); // 100ms delay
};

// Initialize revenue analytics on page load with delay
window.addEventListener('load', function() {
    setTimeout(function() {
        try {
            updateRevenueAnalytics();
            // Start auto-refresh for real-time updates
            startRevenueAnalyticsAutoRefresh();
        } catch (error) {
            console.error('Error initializing revenue analytics:', error);
            // Even if chart fails, ensure metrics are visible
            ensureRevenueMetricsVisible();
        }
    }, 500); // 500ms delay to ensure DOM is fully ready
});

// Auto-refresh revenue analytics for real-time updates
let revenueAnalyticsRefreshInterval = null;

window.startRevenueAnalyticsAutoRefresh = function() {
    // Clear any existing interval
    if (revenueAnalyticsRefreshInterval) {
        clearInterval(revenueAnalyticsRefreshInterval);
    }
    
    // Set up auto-refresh every 30 seconds
    revenueAnalyticsRefreshInterval = setInterval(function() {
        // Only refresh if page is visible (not in background tab)
        if (!document.hidden) {
            updateRevenueAnalytics();
        }
    }, 30000); // 30 seconds
    
    // Also refresh when page becomes visible again
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && revenueAnalyticsRefreshInterval) {
            updateRevenueAnalytics();
        }
    });
};

// Stop auto-refresh (call when page unloads)
window.stopRevenueAnalyticsAutoRefresh = function() {
    if (revenueAnalyticsRefreshInterval) {
        clearInterval(revenueAnalyticsRefreshInterval);
        revenueAnalyticsRefreshInterval = null;
    }
};

// Check for delivery creation events
window.checkForDeliveryCreation = function() {
    const deliveryCreated = sessionStorage.getItem('deliveryCreated');
    const deliveryCreatedTime = sessionStorage.getItem('deliveryCreatedTime');
    
    if (deliveryCreated === 'true' && deliveryCreatedTime) {
        const createdTime = new Date(deliveryCreatedTime);
        const now = new Date();
        const timeDiff = now - createdTime;
        
        // Only refresh if the delivery was created within the last 10 seconds
        if (timeDiff < 10000) {
            console.log('Recent delivery creation detected, refreshing delivery persons');
            refreshDeliveryPersonsData();
            
            // Clear the sessionStorage after processing
            sessionStorage.removeItem('deliveryCreated');
            sessionStorage.removeItem('deliveryCreatedTime');
        }
    }
};

// Refresh all delivery persons related data
window.refreshDeliveryPersonsData = function() {
    // Refresh delivery persons dropdown
    if (typeof loadDeliveryPersonsDropdown === 'function') {
        loadDeliveryPersonsDropdown();
    }
    
    // Refresh delivery persons section
    if (typeof fetchDeliveryPersons === 'function') {
        fetchDeliveryPersons(currentPeriod || 'month');
    }
    
    // Refresh available delivery persons for reassign buttons
    if (typeof loadAvailableDeliveryPersons === 'function') {
        loadAvailableDeliveryPersons();
    }
    
    // Show notification to user
    if (typeof showNotification === 'function') {
        showNotification('Delivery persons list updated automatically', 'success');
    }
};

// Stop auto-refresh when page unloads
window.addEventListener('beforeunload', function() {
    stopRevenueAnalyticsAutoRefresh();
});

// Also listen for delivery updates to refresh immediately
window.addEventListener('deliveryUpdated', function() {
    updateRevenueAnalytics();
    updateStatusDistributionForPeriod('month');
});

window.addEventListener('deliveryCreated', function() {
    updateRevenueAnalytics();
    updateStatusDistributionForPeriod('month');
});

window.addEventListener('deliveryDeleted', function() {
    updateRevenueAnalytics();
    updateStatusDistributionForPeriod('month');
});

// Fallback function to ensure metrics are visible
window.ensureRevenueMetricsVisible = function() {
    try {
        const metrics = {
            totalRevenueAnalytics: 'KSh 2,830',
            avgDailyRevenue: 'KSh 404',
            peakRevenueDay: 'KSh 650',
            peakDayName: 'Mon, Nov 25',
            revenueGrowthRate: '+15.2%'
        };
        
        Object.keys(metrics).forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = metrics[id];
            }
        });
    } catch (error) {
        console.error('Error setting fallback metrics:', error);
    }
};


// ==================== NEW USER MANAGEMENT SYSTEM ====================

// Load users on page load
window.loadNewUsers = function() {
    // First test the health endpoint
    fetch('/api/health')
        .then(response => response.json())
        .then(healthData => {
            console.log('Health Check Result:', healthData);
            console.log('Available routes:', healthData.routes_registered);
            
            // Skip API test and go directly to users endpoint
            return fetch('/api/users/public');
        })
        .then(response => {
            // Check if response is JSON
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                return response.json();
            } else {
                throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}`);
            }
        })
        .then(data => {
            console.log('Public Users Data:', data);
            const usersList = document.getElementById('newUsersList');
            if (!data.success) {
                usersList.innerHTML = `<p class="text-red-500 text-sm text-center py-4">Error: ${data.error || 'Unknown error'}</p>`;
                return;
            }
            
            if (data.users.length === 0) {
                usersList.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No users found</p>';
                return;
            }
            
            const usersHtml = data.users.map(user => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-bold">${user.username[0].toUpperCase()}</span>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-800">${user.username}</div>
                            <div class="text-xs text-gray-500">${user.role}  ${user.created_at}</div>
                            ${user.show_password ? `
                                <div class="text-xs text-gray-400 mt-1">
                                    <span class="font-mono bg-gray-800 text-green-400 px-1 py-0.5 rounded" id="hash-${user.id}">
                                        ${user.password_hash}
                                    </span>
                                    <button onclick="copyPasswordHash(${user.id}, '${user.password_hash}')" 
                                            class="ml-2 text-blue-600 hover:text-blue-800 text-xs underline">
                                        Copy
                                    </button>
                                </div>
                            ` : `
                                <div class="text-xs text-gray-400 mt-1">
                                    <span class="font-mono bg-gray-800 text-green-400 px-1 py-0.5 rounded">
                                        ${user.password_hash.substring(0, 12)}...
                                    </span>
                                    ${user.role === 'admin' || user.role === 'staff' ? `
                                        <button onclick="togglePasswordHash(${user.id}, '${user.password_hash}')" 
                                                class="ml-2 text-blue-600 hover:text-blue-800 text-xs underline">
                                            Show Full
                                        </button>
                                    ` : ''}
                                </div>
                            `}
                            <button onclick="editNewUser(${user.id}, '${user.username}', '${user.role}')" 
                                    class="text-blue-600 hover:bg-blue-100 p-1.5 rounded transition-colors"
                                    title="Edit">
                                <i class="fas fa-edit text-xs"></i>
                            </button>
                            ${user.can_edit ? `
                                <button onclick="deleteNewUser(${user.id}, '${user.username}')" 
                                        class="text-red-600 hover:bg-red-100 p-1.5 rounded transition-colors"
                                        title="Delete">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            ` : ''}
                            <button onclick="deleteNewUser(${user.id}, '${user.username}')" 
                                    class="text-red-600 hover:bg-red-100 p-1.5 rounded transition-colors"
                                    title="Delete">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    ` : '<span class="text-xs text-gray-400 font-medium">Protected</span>'}
                </div>
            `).join('');
            
            usersList.innerHTML = usersHtml;
        })
        .catch(error => {
            console.error('Error loading users:', error);
            const usersList = document.getElementById('newUsersList');
            usersList.innerHTML = `<p class="text-red-500 text-sm text-center py-4">Error loading users: ${error.message}</p>`;
        });
};

// Show new user modal
window.showNewUserModal = function() {
    const modal = document.getElementById('newUserModal');
    document.getElementById('newModalTitle').textContent = 'Add New User';
    document.getElementById('newUsernameInput').value = '';
    document.getElementById('newPasswordInput').value = '';
    document.getElementById('newRoleSelect').value = 'user';
    document.getElementById('newUserIdInput').value = '';
    document.getElementById('passwordRequired').style.display = 'inline';
    document.getElementById('saveButtonText').textContent = 'Add User';
    modal.classList.remove('hidden');
};

// Edit user
window.editNewUser = function(userId, username, role) {
    const modal = document.getElementById('newUserModal');
    document.getElementById('newModalTitle').textContent = 'Edit User';
    document.getElementById('newUsernameInput').value = username;
    document.getElementById('newPasswordInput').value = '';
    document.getElementById('newRoleSelect').value = role || 'user';
    document.getElementById('newUserIdInput').value = userId;
    document.getElementById('passwordRequired').style.display = 'none';
    document.getElementById('saveButtonText').textContent = 'Update User';
    modal.classList.remove('hidden');
};

// Delete user
window.deleteNewUser = function(userId, username) {
    if (confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
        fetch(`/api/users/${userId}`, { method: 'DELETE' })
            .then(response => {
                // Check if response is JSON
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    return response.json();
                } else {
                    throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}`);
                }
            })
            .then(result => {
                if (result.success) {
                    showNotification('User deleted successfully', 'success');
                    loadNewUsers();
                } else {
                    showNotification(result.error || 'Error deleting user', 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                showNotification('Error deleting user: ' + error.message, 'error');
            });
    }
};

// Save user (create or update)
window.saveNewUser = function() {
    const username = document.getElementById('newUsernameInput').value.trim();
    const password = document.getElementById('newPasswordInput').value;
    const role = document.getElementById('newRoleSelect').value;
    const userId = document.getElementById('newUserIdInput').value;
    
    // Validation
    if (!username || username.length < 3) {
        showNotification('Username must be at least 3 characters', 'error');
        return;
    }
    
    if (!userId && (!password || password.length < 6)) {
        showNotification('Password must be at least 6 characters for new users', 'error');
        return;
    }
    
    if (role !== 'admin' && role !== 'user' && role !== 'staff') {
        console.log('Invalid role detected:', role);
        showNotification('Invalid role selected', 'error');
        return;
    }
    
    const isEdit = !!userId;
    const url = isEdit ? `/api/users/${userId}` : '/api/users'; // Use admin endpoint
    const method = isEdit ? 'PUT' : 'POST';
    
    const payload = { username, role };
    if (password) {
        payload.password = password;
    }
    
    console.log('Sending payload:', payload);
    
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(response => {
        console.log('Response status:', response.status);
        
        // Check if response is JSON
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
            return response.json().then(data => {
                console.log('Response data:', data);
                return data;
            });
        } else {
            return response.text().then(text => {
                console.log('Non-JSON response:', text);
                throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}`);
            });
        }
    })
    .then(result => {
        if (result.success) {
            showNotification(result.message, 'success');
            closeNewUserModal();
            loadNewUsers();
        } else {
            showNotification(result.error || 'Error saving user', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving user:', error);
        showNotification('Error saving user: ' + error.message, 'error');
    });
};

// Close modal
window.closeNewUserModal = function() {
    document.getElementById('newUserModal').classList.add('hidden');
};

// Refresh users
window.refreshUsers = function() {
    const usersList = document.getElementById('newUsersList');
    usersList.innerHTML = '<div class="text-center text-gray-500 text-sm py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Refreshing...</div>';
    loadNewUsers();
};

// Modern Shelf Management Functions
window.refreshShelfStats = async function() {
    const refreshBtn = document.getElementById('refreshBtn');
    const availableElement = document.getElementById('availableShelvesCount');
    const occupiedElement = document.getElementById('occupiedShelvesCount');
    const maintenanceElement = document.getElementById('maintenanceShelvesCount');
    const revenueElement = document.getElementById('monthlyRevenueDisplay');
    
    // Add loading animation
    if (refreshBtn) {
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        refreshBtn.disabled = true;
    }
    
    [availableElement, occupiedElement, maintenanceElement, revenueElement].forEach(el => {
        if (el) {
            el.style.opacity = '0.5';
            el.innerHTML = '<i class="fas fa-spinner fa-spin text-sm"></i>';
        }
    });
    
    try {
        // Fetch real-time data from API
        const response = await fetch('/api/shelves', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const shelves = await response.json();
            
            // Calculate real statistics
            const available = shelves.filter(s => s.status === 'available').length;
            const occupied = shelves.filter(s => s.status === 'occupied').length;
            const maintenance = shelves.filter(s => s.status === 'maintenance').length;
            const revenue = shelves.filter(s => s.status === 'occupied').reduce((sum, s) => sum + s.price, 0);
            
            // Update with real data and animations
            setTimeout(() => {
                if (availableElement) {
                    availableElement.style.opacity = '1';
                    availableElement.textContent = available;
                    availableElement.classList.add('animate-pulse');
                    setTimeout(() => availableElement.classList.remove('animate-pulse'), 1000);
                }
                if (occupiedElement) {
                    occupiedElement.style.opacity = '1';
                    occupiedElement.textContent = occupied;
                    occupiedElement.classList.add('animate-pulse');
                    setTimeout(() => occupiedElement.classList.remove('animate-pulse'), 1000);
                }
                if (maintenanceElement) {
                    maintenanceElement.style.opacity = '1';
                    maintenanceElement.textContent = maintenance;
                    maintenanceElement.classList.add('animate-pulse');
                    setTimeout(() => maintenanceElement.classList.remove('animate-pulse'), 1000);
                }
                if (revenueElement) {
                    revenueElement.style.opacity = '1';
                    revenueElement.textContent = `KSh ${revenue.toLocaleString()}`;
                    revenueElement.classList.add('animate-pulse');
                    setTimeout(() => revenueElement.classList.remove('animate-pulse'), 1000);
                }
                
                // Show success notification
                showNotification('Shelf statistics updated successfully!', 'success');
            }, 500);
        } else {
            throw new Error('Failed to fetch shelf data');
        }
    } catch (error) {
        console.error('Error refreshing shelf stats:', error);
        
        // Fallback to original values with error notification
        [availableElement, occupiedElement, maintenanceElement, revenueElement].forEach(el => {
            if (el) {
                el.style.opacity = '1';
                el.innerHTML = el.textContent || '0';
            }
        });
        
        showNotification('Failed to refresh shelf statistics', 'error');
    } finally {
        // Restore refresh button
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
            refreshBtn.disabled = false;
        }
    }
};

// Export shelf report functionality
window.exportShelfReport = function() {
    try {
        const available = document.getElementById('availableShelvesCount').textContent;
        const occupied = document.getElementById('occupiedShelvesCount').textContent;
        const maintenance = document.getElementById('maintenanceShelvesCount').textContent;
        const revenue = document.getElementById('monthlyRevenueDisplay').textContent;
        
        const report = `SHELF MANAGEMENT REPORT
Generated: ${new Date().toLocaleString()}

SUMMARY:
- Available Shelves: ${available}
- Occupied Shelves: ${occupied}
- Maintenance Shelves: ${maintenance}
- Monthly Revenue: ${revenue}

This is an automated report from ErrantMate Shelf Management System.
`;

        // Create and download file
        const blob = new Blob([report], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `shelf_management_report_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showNotification('Shelf report exported successfully!', 'success');
    } catch (error) {
        console.error('Error exporting report:', error);
        showNotification('Failed to export shelf report', 'error');
    }
};

// Notification system
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    
    notification.className = `fixed top-4 right-4 z-50 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-all duration-300`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Password viewing functions
window.togglePasswordHash = function(userId, fullHash) {
    const hashElement = document.getElementById(`hash-${userId}`);
    const button = event.target;
    
    if (hashElement.textContent.includes('...')) {
        hashElement.textContent = fullHash;
        hashElement.classList.remove('bg-gray-800', 'text-green-400');
        hashElement.classList.add('bg-red-100', 'text-red-800', 'px-2', 'py-1');
        button.textContent = 'Hide';
        button.classList.remove('text-blue-600', 'hover:text-blue-800');
        button.classList.add('text-red-600', 'hover:text-red-800');
    } else {
        hashElement.textContent = fullHash.substring(0, 12) + '...';
        hashElement.classList.remove('bg-red-100', 'text-red-800', 'px-2', 'py-1');
        hashElement.classList.add('bg-gray-800', 'text-green-400', 'px-1', 'py-0.5');
        button.textContent = 'Show Full';
        button.classList.remove('text-red-600', 'hover:text-red-800');
        button.classList.add('text-blue-600', 'hover:text-blue-800');
    }
};

window.copyPasswordHash = function(userId, passwordHash) {
    navigator.clipboard.writeText(passwordHash).then(() => {
        showNotification('Password hash copied to clipboard', 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = passwordHash;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Password hash copied to clipboard', 'success');
    });
};

// ==================== END NEW USER MANAGEMENT SYSTEM ====================

</script>


<!-- NEW User Management Modal -->
<div id="newUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 id="newModalTitle" class="text-lg font-semibold text-gray-800">Add New User</h3>
        </div>
        <div class="p-6">
            <input type="hidden" id="newUserIdInput">
            
            <div class="mb-4">
                <label for="newUsernameInput" class="block text-sm font-medium text-gray-700 mb-2">
                    Username <span class="text-red-500">*</span>
                </label>
                <input type="text" 
                       id="newUsernameInput" 
                       autocomplete="off"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="Enter username (min 3 chars)">
            </div>
            
            <div class="mb-4">
                <label for="newRoleSelect" class="block text-sm font-medium text-gray-700 mb-2">
                    Role
                </label>
                <select id="newRoleSelect" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="user">User</option>
                    <option value="staff">Staff</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label for="newPasswordInput" class="block text-sm font-medium text-gray-700 mb-2">
                    Password <span id="passwordRequired" class="text-red-500">*</span>
                </label>
                <input type="password" 
                       id="newPasswordInput" 
                       autocomplete="new-password"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="Enter password (min 6 chars)">
                <p class="text-xs text-gray-500 mt-1">Leave blank to keep current password (for edits)</p>
            </div>
        </div>
        <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
            <button onclick="closeNewUserModal()" 
                    class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                Cancel
            </button>
            <button onclick="saveNewUser()" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <span id="saveButtonText">Save User</span>
            </button>
        </div>
    </div>
</div>

{% endblock %}
